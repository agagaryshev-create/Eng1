<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OGE Tests – Выбор теста</title>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
h1 { text-align: center; }
.levels { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
.levels button { padding: 10px 15px; font-size: 16px; cursor: pointer; border-radius: 8px; border: 1px solid #333; }
.menu { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
.menu .card {
  flex: 1 1 200px;
  max-width: 250px;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: center;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  text-decoration: none;
  color: black;
}
.menu .card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
#stats { margin-top: 30px; overflow-x: auto; }
#stats table { width: 100%; border-collapse: collapse; }
#stats th, #stats td { border: 1px solid #333; padding: 8px; text-align: center; }
</style>
</head>
<body>

<h1>OGE Tests – Выберите уровень</h1>

<div class="levels">
  <button data-level="1">Уровень 1</button>
  <button data-level="2">Уровень 2</button>
  <button data-level="3">Уровень 3</button>
  <button data-level="random">Случайные тесты</button>
</div>

<div class="menu" id="test-menu"></div>

<div id="stats">Войдите, чтобы увидеть статистику.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, user => {
  currentUser = user;
  if(currentUser) showStats();
});

let tests = {}; // сюда подгружаем JSON
let currentLevelTests = [];

// ===== Подгрузка JSON с тестами =====
async function loadTests() {
  const res = await fetch('tests.json');
  tests = await res.json();
}
await loadTests();

// ===== Генерация карточек =====
function renderCards(testArray) {
  const menu = document.getElementById('test-menu');
  menu.innerHTML = '';
  testArray.forEach(t => {
    const card = document.createElement('a');
    card.className = 'card';
    card.href = `test.html?id=${t.id}`; // один универсальный test.html
    card.innerHTML = `<h3>${t.title}</h3><p>Уровень: ${t.level}</p>`;
    menu.appendChild(card);
  });
}

// ===== Обработчики выбора уровня =====
document.querySelectorAll('.levels button').forEach(btn => {
  btn.addEventListener('click', () => {
    const level = btn.dataset.level;
    if(level === 'random') {
      let allTests = [...tests["1"], ...tests["2"], ...tests["3"]];
      currentLevelTests = allTests.sort(() => Math.random() - 0.5).slice(0, 5);
    } else {
      currentLevelTests = tests[level] || [];
    }
    renderCards(currentLevelTests);
  });
});

// ===== Статистика =====
async function showStats() {
  const statsDiv = document.getElementById('stats');
  let html = '<h2>История результатов</h2><table><tr><th>Тест</th><th>Баллы</th><th>Дата</th></tr>';
  
  for(let level in tests) {
    for(let t of tests[level]) {
      const colRef = collection(db, "results", currentUser.uid, `${t.id}_attempts`);
      const snap = await getDocs(colRef);
      if(snap.empty) continue;
      const last = snap.docs[snap.docs.length-1].data();
      const dateStr = last.date?.toDate ? last.date.toDate().toLocaleString() : '';
      html += `<tr><td>${t.title}</td><td>${last.score} / ${t.maxPoints}</td><td>${dateStr}</td></tr>`;
    }
  }

  html += '</table>';
  statsDiv.innerHTML = html;
}
</script>

</body>
</html>
