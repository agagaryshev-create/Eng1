<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OGE Tests – Выбор теста</title>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
h1 { text-align: center; }
.levels { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
.levels button { padding: 10px 15px; font-size: 16px; cursor: pointer; border-radius: 8px; border: 1px solid #333; }
.menu { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
.menu .card {
  flex: 1 1 200px;
  max-width: 250px;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: center;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  text-decoration: none;
  color: black;
}
.menu .card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
#stats { margin-top: 30px; overflow-x: auto; }
#stats table { width: 100%; border-collapse: collapse; }
#stats th, #stats td { border: 1px solid #333; padding: 8px; text-align: center; }
</style>
</head>
<body>

<!-- Кнопка возврата на главную -->
<div style="text-align:center; margin-bottom:20px;">
  <button onclick="location.href='index.html'" style="padding:10px 20px; font-size:16px; cursor:pointer;">
    ← На главную
  </button>
</div>

<h1>OGE Tests – Выберите уровень</h1>

<div class="levels">
  <button data-level="1">Уровень 1</button>
  <button data-level="2">Уровень 2</button>
  <button data-level="3">Уровень 3</button>
  <button data-level="4">Уровень 4</button>
  <button data-level="random">Случайные тесты</button>
</div>

<div class="menu" id="test-menu"></div>

<div id="stats"></div>

<div style="text-align:center; margin-top:20px;">
  <button id="loadStatsBtn" style="padding:10px 20px; font-size:16px; display:none;">
    Показать статистику
  </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  getDocs 
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";


// ===============================
//  Firebase Init
// ===============================
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let statsLoaded = false;


// ===============================
//  DOM элементы
// ===============================
const statsDiv = document.getElementById("stats");
const loadStatsBtn = document.getElementById("loadStatsBtn");


// ===============================
//  Форма логина
// ===============================
function showLoginForm() {
  statsDiv.innerHTML = `
    <h2>Вход</h2>
    <input id="email" type="email" placeholder="Email" style="width:100%;padding:8px;margin:5px 0;">
    <input id="password" type="password" placeholder="Пароль" style="width:100%;padding:8px;margin:5px 0;">
    <button id="loginBtn" style="padding:10px 15px;margin-top:10px;">Войти</button>
    <p id="loginError" style="color:red;"></p>
  `;

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value.trim();
    const err = document.getElementById("loginError");

    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      err.textContent = "Ошибка: " + e.message;
    }
  };
}


// ===============================
//  Показ кнопки статистики
// ===============================
function showStatsButton() {
  statsDiv.innerHTML = "<p>Нажмите, чтобы загрузить статистику.</p>";
  loadStatsBtn.style.display = "inline-block";
}


// ===============================
//  Прогресс загрузки
// ===============================
function showLoading() {
  statsDiv.innerHTML = `
    <div style="text-align:center; padding:20px;">
      <div style="
        border: 4px solid #ccc; 
        border-top: 4px solid #333; 
        border-radius: 50%; 
        width: 40px; 
        height: 40px; 
        margin: 0 auto;
        animation: spin 0.8s linear infinite;
      "></div>
      <p>Загрузка...</p>
    </div>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
}


// ===============================
//  Загрузка статистики
// ===============================
async function loadStats() {
  if (!currentUser) return;

  if (statsLoaded) return;      // не грузим повторно
  statsLoaded = true;

  showLoading();

  let html = `
    <h2>История результатов</h2>
    <table>
      <tr><th>Тест</th><th>Баллы</th><th>Дата</th></tr>
    `;

  for (const lvl of ["1", "2", "3", "4"]) {
    const arr = tests[lvl];
    if (!Array.isArray(arr)) continue;

    for (const t of arr) {
      try {
        const colRef = collection(db, "results", currentUser.uid, `${t.id}_attempts`);
        const snap = await getDocs(colRef);
        if (snap.empty) continue;

        const last = snap.docs[snap.docs.length - 1].data();
        const dateStr = last.date?.toDate ? last.date.toDate().toLocaleString() : "";

        html += `<tr>
          <td>${t.title}</td>
          <td>${last.score} / ${t.maxPoints}</td>
          <td>${dateStr}</td>
        </tr>`;
      } catch (e) {
        console.error("Ошибка чтения статистики", e);
      }
    }
  }

  html += "</table>";
  statsDiv.innerHTML = html;
}


// ===============================
//  Firebase: отслеживание логина
// ===============================
onAuthStateChanged(auth, user => {
  currentUser = user;

  if (currentUser) {
    console.log("Пользователь вошёл:", currentUser.email);
    showStatsButton();
  } else {
    console.log("Пользователь не авторизован");
    loadStatsBtn.style.display = "none";
    showLoginForm();
  }
});


// ===============================
//  Подключение кнопки загрузки
// ===============================
loadStatsBtn.onclick = () => loadStats();


// ===============================
//  Подгружаем JSON с тестами
// ===============================
let tests = {};

async function loadTests() {
  try {
    const res = await fetch("tests.json");
    tests = await res.json();
  } catch(e) {
    console.error("Ошибка загрузки tests.json", e);
  }
}
await loadTests();


// ===============================
//  Рендер кнопок тестов (как было)
// ===============================
function renderCards(testArray) {
  const menu = document.getElementById('test-menu');
  menu.innerHTML = '';
  testArray.forEach((t, index) => {
    const card = document.createElement('a');
    card.className = 'card';
    card.href = `test.html?id=${t.id}`;
    card.innerHTML = `
      <h3>${index + 1}. ${t.title}</h3>
      <p>Тема: ${t.topic} | Уровень: ${t.level}</p>`;
    menu.appendChild(card);
  });
}

document.querySelectorAll('.levels button').forEach(btn => {
  btn.addEventListener('click', () => {
    const level = btn.dataset.level;
    let current = [];

    if (level === "random") {
      const all = [...tests["1"], ...tests["2"], ...tests["3"], ...tests["4"]];
      current = all.sort(() => Math.random() - 0.5).slice(0, 5);
    } else {
      current = tests[level] || [];
    }

    renderCards(current);
  });
});
</script>

</body>
</html>
