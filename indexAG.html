<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>English OGE Tests – Главная</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
h1 { text-align: center; }
.auth-box { max-width: 400px; margin: 0 auto; }
input, button { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; }
button { cursor: pointer; }

.menu { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
.menu .card {
  flex: 1 1 200px;
  max-width: 250px;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: center;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  text-decoration: none; color: black;
}
.menu .card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

#stats { margin-top: 30px; overflow-x: auto; }
#stats table { width: 100%; border-collapse: collapse; }
#stats th, #stats td { border: 1px solid #333; padding: 8px; text-align: center; }
.progress-container { background: #eee; border-radius: 5px; overflow: hidden; height: 20px; margin-top: 5px; }
.progress-bar { height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); width: 0%; text-align: center; color: white; font-weight: bold; }

#scoreChart { max-width: 800px; margin-top: 30px; display: none; }

@media(max-width:600px){
  .menu { flex-direction: column; align-items: center; }
}
</style>
</head>
<body>

<h1>English OGE Tests</h1>

<div class="auth-box" id="auth">
  <h3>Авторизация</h3>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Пароль">
  <button id="register-btn">Зарегистрироваться</button>
  <button id="login-btn">Войти</button>
  <button id="logout-btn" style="display:none;">Выйти</button>
  <div id="auth-msg"></div>
</div>

<div class="menu">
  <a href="test1.html" class="card" target="_blank">Test 1: Alice & Tom</a>
  <a href="test2.html" class="card" target="_blank">Test 2: Sports</a>
  <a href="test3.html" class="card" target="_blank">Test 3: Holidays</a>
  <a href="test4.html" class="card" target="_blank">Test 4: Environment</a>
  <a href="test5.html" class="card" target="_blank">Test 5: Daily Life</a>
</div>

<div id="stats">Войдите, чтобы увидеть статистику.</div>
<canvas id="scoreChart"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase конфиг =====
const firebaseConfig = {
  apiKey: "ВАШ_API_KEY",
  authDomain: "ВАШ_AUTH_DOMAIN",
  projectId: "ВАШ_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMsg = document.getElementById("auth-msg");
const statsDiv = document.getElementById("stats");
const chartCanvas = document.getElementById("scoreChart");

let scoreChartInstance = null;
const testIds = ["test1","test2","test3","test4","test5"];
const maxPointsByTest = { test1:3, test2:3, test3:5, test4:3, test5:5 };

// ===== Регистрация =====
registerBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;
    authMsg.innerText = "Регистрация успешна!";

    // Создаём пустой документ в results для нового пользователя
    await setDoc(doc(db, "results", uid), { created: new Date() });

  } catch (err) {
    authMsg.innerText = "Ошибка: " + err.message;
  }
});

// ===== Вход =====
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    authMsg.innerText = "Вход выполнен!";
  } catch (err) {
    authMsg.innerText = "Ошибка: " + err.message;
  }
});

// ===== Выход =====
logoutBtn.addEventListener("click", async () => {
  try { await signOut(auth); } 
  catch (err) { alert("Ошибка выхода: " + err.message); }
});

// ===== Слежение за авторизацией =====
onAuthStateChanged(auth, async (user) => {
  if(user){
    emailInput.style.display="none";
    passwordInput.style.display="none";
    registerBtn.style.display="none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline";
    authMsg.innerText="Вы вошли как: "+user.email;
    await showFullStats(user.uid);
  } else {
    emailInput.style.display="inline";
    passwordInput.style.display="inline";
    registerBtn.style.display="inline";
    loginBtn.style.display="inline";
    logoutBtn.style.display="none";
    statsDiv.innerText="Войдите, чтобы увидеть статистику.";
    chartCanvas.style.display="none";
  }
});

// ===== Вывод статистики =====
async function showFullStats(uid){
  const testsData = {};
  const chartLabels = [], chartData = [];
  let totalLastAttempts=0, totalMaxPoints=0;

  for(let testId of testIds){
    const attemptsCol = collection(db,"results",uid,`${testId}_attempts`);
    const attemptsSnapshot = await getDocs(attemptsCol);
    if(attemptsSnapshot.empty) continue;

    const attemptsArray = attemptsSnapshot.docs.map(doc=>{
      const data = doc.data();
      return { score:data.score??0, date:data.date?.toDate?data.date.toDate():null };
    });
    attemptsArray.sort((a,b)=>a.date-b.date);
    testsData[testId]=attemptsArray;

    const lastAttempt=attemptsArray[attemptsArray.length-1];
    totalLastAttempts+=lastAttempt.score;
    totalMaxPoints+=maxPointsByTest[testId];

    attemptsArray.forEach((a,idx)=>{
      const dateStr=a.date?a.date.toLocaleString():"неизвестно";
      chartLabels.push(`${testId}${idx===attemptsArray.length-1?' (последняя)':''} (${dateStr.split(',')[0]})`);
      chartData.push(a.score);
    });
  }

  // ===== Таблица с прогресс-барами =====
  let html="<h2>История результатов</h2><table><tr><th>Тест</th><th>Баллы</th><th>Прогресс</th></tr>";
  for(let testId of testIds){
    const attempts=testsData[testId]||[];
    const lastScore = attempts.length>0?attempts[attempts.length-1].score:0;
    const maxScore=maxPointsByTest[testId];
    const percent = Math.round(lastScore/maxScore*100);

    html+=`<tr><td>${testId}</td><td>${lastScore} / ${maxScore}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${percent}%">${percent}%</div>
        </div>
      </td></tr>`;
  }
  html+=`<tr><td><strong>Итого</strong></td><td>${totalLastAttempts} / ${totalMaxPoints}</td><td></td></tr></table>`;
  statsDiv.innerHTML=html;

  // ===== График =====
  if(chartData.length>0){
    chartCanvas.style.display="block";
    if(scoreChartInstance) scoreChartInstance.destroy();
    scoreChartInstance=new Chart(chartCanvas,{
      type:'line',
      data:{ labels:chartLabels, datasets:[{label:'Баллы', data:chartData, borderColor:'blue', fill:false, tension:0.2}] },
      options:{ responsive:true }
    });
  } else chartCanvas.style.display="none";
}
</script>

</body>
</html>
