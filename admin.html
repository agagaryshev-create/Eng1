<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Admin — OGE stats</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;max-width:1400px;margin:auto}
    h1{margin-bottom:6px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    button{padding:8px 12px;font-size:14px;cursor:pointer}
    #progressWrap{margin:10px 0;display:none}
    #progressBar{height:20px;background:#e6e6e6;border-radius:6px;overflow:hidden}
    #progressInner{height:100%;width:0;background:linear-gradient(90deg,#4caf50,#81c784);text-align:center;color:white;line-height:20px;font-weight:600}
    #progressText{font-size:13px;color:#444;margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f5f5f5}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:0}
    .note{color:#555;font-size:13px}
  </style>
</head>
<body>

<h1>Админка — статистика (все пользователи)</h1>
<p class="note">Показ всех тестов по пользователям в табличной форме.</p>

<div class="controls">
  <button id="btnAll">Загрузить статистику — все тесты</button>
  <button id="btnBase">Только базовые 5 тестов</button>
  <button id="btnVisits">Статистика посещений</button>
  <button id="btnVisitsDetailed">Подробная статистика посещений</button>
  <button id="btnKidsVisits">Kids статистика</button>
  <button id="btnKidsVisitsDetailed">Kids подробно</button>
  <button id="btnExport">Экспорт CSV</button>
</div>

<div id="progressWrap">
  <div id="progressBar"><div id="progressInner">0%</div></div>
  <div id="progressText"></div>
</div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase config ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const output = document.getElementById('output');
const progressWrap = document.getElementById('progressWrap');
const progressInner = document.getElementById('progressInner');
const progressText = document.getElementById('progressText');

function showProgress(show){
  progressWrap.style.display = show ? 'block' : 'none';
}
function setProgress(percent, text=''){
  progressInner.style.width = Math.round(percent) + '%';
  progressInner.innerText = Math.round(percent) + '%';
  progressText.innerText = text || '';
}

// ====== Base tests ======
const baseTests = [
  {id:'test1', title:'Alice & Tom', maxPoints:3},
  {id:'test2', title:'Sports', maxPoints:3},
  {id:'test3', title:'Holidays', maxPoints:5},
  {id:'test4', title:'Environment', maxPoints:3},
  {id:'test5', title:'Daily Life', maxPoints:5},
];

// ====== Load tests JSON ======
let testsJSON = {};
async function loadTestsJSON(){
  try {
    const res = await fetch('tests.json');
    if(res.ok){
      testsJSON = await res.json();
    } else testsJSON = {};
  } catch { testsJSON = {}; }
}
await loadTestsJSON();

// ====== All tests array ======
function getAllTests(baseOnly=false){
  let allTests = [...baseTests];
  if(!baseOnly){
    for(const level in testsJSON){
      allTests.push(...testsJSON[level].map(t => ({id:t.id, title:t.title, maxPoints:t.maxPoints ?? 5})));
    }
  }
  return allTests;
}

// ====== Get all users ======
async function getAllUserIds(){
  const snap = await getDocs(collection(db,'results'));
  return snap.docs.map(d => d.id);
}

// ====== Get last attempt for test ======
async function getLastAttempt(uid, testId){
  try{
    const attemptsCol = collection(db,'results',uid,`${testId}_attempts`);
    const snap = await getDocs(attemptsCol);
    if(snap.empty) return null;
    return snap.docs[snap.docs.length-1].data();
  }catch{ return null; }
}

// ====== Render table ======
async function renderStats(baseOnly=false){
  showProgress(true);
  output.innerHTML = "Загрузка статистики…";
  const users = await getAllUserIds();
  const allTests = getAllTests(baseOnly);

  let html = "<table><thead><tr><th>User</th>";
  allTests.forEach(t => html += `<th>${t.id}</th>`);
  html += "<th>Итого</th></tr></thead><tbody>";

  let userCount = 0;
  for(const uid of users){
    let totalScore = 0;
    html += `<tr><td>${uid}</td>`;
    for(const t of allTests){
      const attempt = await getLastAttempt(uid,t.id);
      const score = attempt?.score ?? 0;
      html += `<td>${score}/${t.maxPoints}</td>`;
      totalScore += score;
    }
    html += `<td><strong>${totalScore}</strong></td>`;
    html += "</tr>";
    userCount++;
    setProgress(userCount/users.length*100, `Загружено пользователей: ${userCount}/${users.length}`);
  }

  html += "</tbody></table>";
  output.innerHTML = html;
  showProgress(false);
}

// ====== BUTTONS ======
document.getElementById('btnAll').addEventListener('click', ()=>renderStats(false));
document.getElementById('btnBase').addEventListener('click', ()=>renderStats(true));

</script>
</body>
</html>
