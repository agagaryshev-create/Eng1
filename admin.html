<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <style>
        table { border-collapse: collapse; }
        td, th { border: 1px solid #777; padding: 6px; }
    </style>
</head>
<body>
<h2>Results</h2>
<table id="resultsTable">
    <thead>
        <tr>
            <th>Email / UID</th>
            <th>test1</th>
            <th>test2</th>
            <th>test3</th>
            <th>test4</th>
            <th>test5</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC6lftEB2nUifpZhE8Ays0d__BzynmvYdY",
    authDomain: "eng1-4fbc2.firebaseapp.com",
    projectId: "eng1-4fbc2",
    storageBucket: "eng1-4fbc2.firebasestorage.app",
    messagingSenderId: "160245467739",
    appId: "1:160245467739:web:2022400986a2938748fae5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- тесты и максимальные баллы ---
const tests = ["test1","test2","test3","test4","test5"];
const maxPoints = { test1:3, test2:3, test3:5, test4:3, test5:5 };

async function loadResults() {
    const resultsCol = collection(db, "results");
    const usersSnap = await getDocs(resultsCol);

    const rows = []; // ← собираем сюда ВСЁ

    for (const userDoc of usersSnap.docs) {
        const uid = userDoc.id;
        let totalEarned = 0;
        let totalPossible = 0;

        const row = { uid };

        for (const test of tests) {
            const sub = collection(db, `results/${uid}/${test}_attempts`);
            const subSnap = await getDocs(sub);

            let best = 0;

            subSnap.forEach(a => {
                const pts = a.data().score || 0;
                if (pts > best) best = pts;
            });

            row[test] = `${best} / ${maxPoints[test]}`;

            totalEarned += best;
            totalPossible += maxPoints[test];
        }

        row.total = `${totalEarned} / ${totalPossible}`;
        rows.push(row);
    }

    renderTable(rows);
}

function renderTable(rows) {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";

    for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.uid}</td>
            <td>${r.test1}</td>
            <td>${r.test2}</td>
            <td>${r.test3}</td>
            <td>${r.test4}</td>
            <td>${r.test5}</td>
            <td>${r.total}</td>
        `;
        tbody.appendChild(tr);
    }
}

loadResults();
</script>

</body>
</html>
