<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Admin Stats</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    button { padding: 10px 20px; margin-right: 10px; }
  </style>
</head>
<body>

<h1>–ê–¥–º–∏–Ω–∫–∞</h1>
<button id="loadBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
<button id="diagBtn">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>

<div id="output"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
    authDomain: "engtestoge.firebaseapp.com",
    projectId: "engtestoge"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const testIds = ["test1", "test2", "test3", "test4", "test5"];
  const maxPoints = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };

  document.getElementById("loadBtn").onclick = loadStats;
  document.getElementById("diagBtn").onclick = runDiag;

  // -----------------------------------------
  //   –ì–õ–ê–í–ù–ê–Ø –ù–û–í–ê–Ø –ß–ê–°–¢–¨
  //   –°–∫–∞–Ω–∏—Ä—É–µ—Ç –í–°–ï testX_attempts –≤–æ –≤—Å–µ–π –ë–î
  //   –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –í–°–ï UID, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç
  // -----------------------------------------
  async function collectAllUIDs() {
    let uids = new Set();

    const resultsCol = collection(db, "results");
    const resultsSnap = await getDocs(resultsCol);

    // –î–æ–±–∞–≤–ª—è–µ–º UID, –∫–æ—Ç–æ—Ä—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    resultsSnap.forEach(d => uids.add(d.id));

    // –¢–µ–ø–µ—Ä—å –∏—â–µ–º UID –≤ –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö testX_attempts
    // –î–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç
    for (let uidDoc of resultsSnap.docs) {
      const uid = uidDoc.id;

      for (let testId of testIds) {
        const attemptsCol = collection(db, `results/${uid}/${testId}_attempts`);
        const attemptsSnap = await getDocs(attemptsCol);

        if (!attemptsSnap.empty) {
          uids.add(uid);
        }
      }
    }

    // –ù–û! –≠–¢–û –í–°–Å –ï–©–Å –ù–ï –•–í–ê–¢–ê–ï–¢!
    // Firestore –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç.
    // –ê —É —Ç–µ–±—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏—Ç—É–∞—Ü–∏—è: –≤ results/–ù–ï–¢ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤,
    // –Ω–æ –µ—Å—Ç—å —Ç–∞–∫–∏–µ –ø—É—Ç–∏ –∫–∞–∫:
    //
    // results/G6910.../test1_attempts/xxxx
    //
    // –ß—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å —Ç–∞–∫–∏–µ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏–∏, –º—ã –¥–µ–ª–∞–µ–º:
    //
    for (let testId of testIds) {
      const attemptsRoot = collection(db, `results`);
      const resSnap2 = await getDocs(attemptsRoot);

      for (let doc of resSnap2.docs) {
        const attempts = await getDocs(
          collection(db, `results/${doc.id}/${testId}_attempts`)
        );
        if (!attempts.empty) {
          uids.add(doc.id);
        }
      }
    }

    return Array.from(uids);
  }

  // -------------------------------
  // üìå –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  // -------------------------------
  async function loadStats() {
    const output = document.getElementById("output");
    output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    const uidList = await collectAllUIDs();

    let html = `<table><tr><th>Email / UID</th>`;
    testIds.forEach(t => html += `<th>${t}</th>`);
    html += `<th>Total</th></tr>`;

    for (let uid of uidList) {
      html += `<tr><td>${uid}</td>`;

      let total = 0;
      let totalMax = 0;

      for (let testId of testIds) {
        const attemptsCol = collection(db, `results/${uid}/${testId}_attempts`);
        const snap = await getDocs(attemptsCol);

        if (snap.empty) {
          html += `<td>‚Äì</td>`;
          continue;
        }

        let lastScore = 0;
        snap.forEach(doc => {
          const s = doc.data().score ?? 0;
          if (s > lastScore) lastScore = s;
        });

        total += lastScore;
        totalMax += maxPoints[testId];

        html += `<td>${lastScore} / ${maxPoints[testId]}</td>`;
      }

      html += `<td>${total} / ${totalMax}</td></tr>`;
    }

    html += `</table>`;
    output.innerHTML = html;
  }

  // ---------------------------
  // üìå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
  // ---------------------------
  async function runDiag() {
    const output = document.getElementById("output");
    let html = "<h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Firestore</h3>";

    const uids = await collectAllUIDs();

    html += `–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ UID: ${uids.length}<br><br>`;

    for (let uid of uids) {
      html += `<b>${uid}</b><br>`;

      for (let testId of testIds) {
        const attemptsSnap = await getDocs(
          collection(db, `results/${uid}/${testId}_attempts`)
        );

        html += `&nbsp;&nbsp;${testId}_attempts ‚Äî ${attemptsSnap.size} –∑–∞–ø–∏—Å–µ–π<br>`;
      }

      html += `<br>`;
    }

    output.innerHTML = html;
  }

</script>

</body>
</html>
