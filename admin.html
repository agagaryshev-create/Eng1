<button id="loadStatsBtn">Получить Стат Now</button>
<table id="statsTable" border="1" style="margin-top:20px; border-collapse:collapse;">
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "..."
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const testIds = ["test1", "test2", "test3", "test4", "test5"];
  const maxPointsByTest = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };

  document.getElementById("loadStatsBtn").onclick = loadStats;

  async function loadStats() {
    const table = document.getElementById("statsTable");
    table.innerHTML = "<tr><th>Email / UID</th>" +
      testIds.map(t => `<th>${t}</th>`).join("") +
      "<th>Total</th></tr>";

    // 1. Получаем список всех пользователей в results
    const resultsCol = collection(db, "results");
    const resultsSnapshot = await getDocs(resultsCol);

    // Если пусто — ошибка
    if (resultsSnapshot.empty) {
      table.innerHTML += "<tr><td colspan='7'>Нет данных</td></tr>";
      return;
    }

    // 2. Для каждого UID получаем тесты
    for (let docSnap of resultsSnapshot.docs) {
      const uid = docSnap.id;

      let rowScores = {};
      let totalScore = 0;
      let totalMax = 0;

      for (let testId of testIds) {
        const attemptsCol = collection(db, "results", uid, `${testId}_attempts`);
        const attemptsSnapshot = await getDocs(attemptsCol);

        let lastScore = 0;

        if (!attemptsSnapshot.empty) {
          let arr = attemptsSnapshot.docs.map(d => {
            const data = d.data();
            return {
              score: data.score ?? 0,
              date: data.date?.toDate ? data.date.toDate() : new Date(0)
            };
          });

          // сортировка
          arr.sort((a, b) => a.date - b.date);

          lastScore = arr[arr.length - 1].score;
        }

        rowScores[testId] = lastScore;
        totalScore += lastScore;
        totalMax += maxPointsByTest[testId];
      }

      // 3. Добавляем строку в таблицу
      const tr = document.createElement("tr");

      tr.innerHTML =
        `<td>${uid}</td>` +
        testIds.map(t => `<td>${rowScores[t]} / ${maxPointsByTest[t]}</td>`).join("") +
        `<td>${totalScore} / ${totalMax}</td>`;

      table.appendChild(tr);
    }
  }
</script>
