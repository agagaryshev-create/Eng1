<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Admin — OGE stats (all users, same logic as index)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;max-width:1200px;margin:auto}
    h1{margin-bottom:6px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    button{padding:8px 12px;font-size:14px;cursor:pointer}
    #progressWrap{margin:10px 0;display:none}
    #progressBar{height:20px;background:#e6e6e6;border-radius:6px;overflow:hidden}
    #progressInner{height:100%;width:0;background:linear-gradient(90deg,#4caf50,#81c784);text-align:center;color:white;line-height:20px;font-weight:600}
    #progressText{font-size:13px;color:#444;margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f5f5f5}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:0}
    .note{color:#555;font-size:13px}
  </style>
</head>
<body>

<h1>Админка — статистика (все пользователи)</h1>
<p class="note">Эта страница использует ту же логику чтения результатов, что и index.html.</p>

<div class="controls">
  <button id="btnAll">Загрузить статистику — все тесты</button>
  <button id="btnBase">Только базовые 5 тестов</button>
  <button id="btnVisits">Статистика посещений</button>
  <button id="btnVisitsDetailed">Подробная статистика посещений</button>

  <!-- === NEW BUTTONS FOR KIDS === -->
  <button id="btnKidsVisits">Kids статистика</button>
  <button id="btnKidsVisitsDetailed">Kids подробно</button>

  <button id="btnExport">Экспорт CSV</button>
</div>

<div id="progressWrap">
  <div id="progressBar"><div id="progressInner">0%</div></div>
  <div id="progressText"></div>
</div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase config ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const output = document.getElementById('output');

// ======= Кнопка 1: все тесты (базовые + новые) =======
document.getElementById("btnAll").addEventListener("click", async () => {
  output.innerHTML = "Загрузка полной статистики…";

  try {
    // Получаем список пользователей
    const usersSnap = await getDocs(collection(db, "results"));
    const users = usersSnap.docs.map(u => ({ uid: u.id, ...u.data() }));

    // Получаем список всех тестов (5 базовых + новые)
    const baseTests = [
      { id: 'test1', title: 'Alice & Tom', maxPoints: 3 },
      { id: 'test2', title: 'Sports', maxPoints: 3 },
      { id: 'test3', title: 'Holidays', maxPoints: 5 },
      { id: 'test4', title: 'Environment', maxPoints: 3 },
      { id: 'test5', title: 'Daily Life', maxPoints: 5 }
    ];

    // Новые тесты (для примера, можно подгружать из JSON или Firestore)
    const newTestsSnap = await getDocs(collection(db, "tests")); // коллекция всех новых тестов
    const newTests = newTestsSnap.docs.map(d => ({ id: d.id, title: d.data().title, maxPoints: d.data().maxPoints || 5 }));

    const allTests = [...baseTests, ...newTests];

    let html = "<h2>Полная статистика пользователей</h2>";
    html += "<table><thead><tr><th>User</th>";

    allTests.forEach(t => html += `<th>${t.id}</th>`);
    html += "<th>Итого</th></tr></thead><tbody>";

    for (const user of users) {
      html += `<tr><td>${user.uid}</td>`;
      let totalScore = 0;
      let totalMax = 0;

      for (const test of allTests) {
        // Достаем последнюю попытку теста для пользователя
        const attemptsCol = collection(db, `results/${user.uid}/${test.id}_attempts`);
        const attemptsSnap = await getDocs(attemptsCol);
        const lastAttemptDoc = attemptsSnap.docs[attemptsSnap.docs.length - 1];
        const lastAttempt = lastAttemptDoc?.data();
        const score = lastAttempt?.score ?? 0;

        html += `<td>${score}/${test.maxPoints}</td>`;
        totalScore += score;
        totalMax += test.maxPoints;
      }

      html += `<td>${totalScore}/${totalMax}</td></tr>`;
    }

    html += "</tbody></table>";
    output.innerHTML = html;

  } catch (e) {
    console.error(e);
    output.innerHTML = "<b>Ошибка загрузки полной статистики</b>";
  }
});

// ======= Остальные кнопки остаются без изменений =======

// Для примера: кнопка 2 (только базовые 5 тестов)
document.getElementById("btnBase").addEventListener("click", async () => {
  output.innerHTML = "Загрузка статистики базовых тестов…";

  try {
    const usersSnap = await getDocs(collection(db, "results"));
    const users = usersSnap.docs.map(u => ({ uid: u.id, ...u.data() }));

    const baseTests = [
      { id: 'test1', title: 'Alice & Tom', maxPoints: 3 },
      { id: 'test2', title: 'Sports', maxPoints: 3 },
      { id: 'test3', title: 'Holidays', maxPoints: 5 },
      { id: 'test4', title: 'Environment', maxPoints: 3 },
      { id: 'test5', title: 'Daily Life', maxPoints: 5 }
    ];

    let html = "<h2>Статистика базовых тестов</h2>";
    html += "<table><thead><tr><th>User</th>";
    baseTests.forEach(t => html += `<th>${t.id}</th>`);
    html += "<th>Итого</th></tr></thead><tbody>";

    for (const user of users) {
      html += `<tr><td>${user.uid}</td>`;
      let totalScore = 0;
      let totalMax = 0;

      for (const test of baseTests) {
        const attemptsCol = collection(db, `results/${user.uid}/${test.id}_attempts`);
        const attemptsSnap = await getDocs(attemptsCol);
        const lastAttemptDoc = attemptsSnap.docs[attemptsSnap.docs.length - 1];
        const lastAttempt = lastAttemptDoc?.data();
        const score = lastAttempt?.score ?? 0;

        html += `<td>${score}/${test.maxPoints}</td>`;
        totalScore += score;
        totalMax += test.maxPoints;
      }

      html += `<td>${totalScore}/${totalMax}</td></tr>`;
    }

    html += "</tbody></table>";
    output.innerHTML = html;

  } catch (e) {
    console.error(e);
    output.innerHTML = "<b>Ошибка загрузки статистики базовых тестов</b>";
  }
});

// Остальные кнопки (visits, kids, export) оставлены без изменений
</script>

</body>
</html>
