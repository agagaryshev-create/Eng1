<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Admin — OGE stats (all users, same logic as index)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;max-width:1200px;margin:auto}
    h1{margin-bottom:6px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    button{padding:8px 12px;font-size:14px;cursor:pointer}
    #progressWrap{margin:10px 0;display:none}
    #progressBar{height:20px;background:#e6e6e6;border-radius:6px;overflow:hidden}
    #progressInner{height:100%;width:0;background:linear-gradient(90deg,#4caf50,#81c784);text-align:center;color:white;line-height:20px;font-weight:600}
    #progressText{font-size:13px;color:#444;margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f5f5f5}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:0}
    .note{color:#555;font-size:13px}
  </style>
</head>
<body>

<h1>Админка — статистика (все пользователи)</h1>
<p class="note">Эта страница использует ту же логику чтения результатов, что и index.html.</p>

<div class="controls">
  <button id="btnAll">Загрузить статистику — все тесты</button>
  <button id="btnBase">Только базовые 5 тестов</button>
  <button id="btnVisits">Статистика посещений</button>
  <button id="btnVisitsDetailed">Подробная статистика посещений</button>
  <button id="btnKidsVisits">Kids статистика</button>
  <button id="btnKidsVisitsDetailed">Kids подробно</button>
  <button id="btnExport">Экспорт CSV</button>
</div>

<div id="progressWrap">
  <div id="progressBar"><div id="progressInner">0%</div></div>
  <div id="progressText"></div>
</div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, doc,
  query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase config ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const output = document.getElementById('output');
const progressWrap = document.getElementById('progressWrap');
const progressInner = document.getElementById('progressInner');
const progressText = document.getElementById('progressText');

// === Convert timestamp helper ===
function convertTimestampToDate(timestamp) {
  return new Date(timestamp.seconds * 1000);
}

// ===============================
// ======== BUTTON 1 & 2 =========
// ===============================

async function loadUsers() {
  const snap = await getDocs(collection(db, 'results'));
  return snap.docs.map(d => ({ uid: d.id }));
}

// Базовые тесты
const baseTests = [
  {id:'test1', title:'Alice & Tom', maxPoints:3},
  {id:'test2', title:'Sports', maxPoints:3},
  {id:'test3', title:'Holidays', maxPoints:5},
  {id:'test4', title:'Environment', maxPoints:3},
  {id:'test5', title:'Daily Life', maxPoints:5},
];

// ===== Кнопка 2: Только базовые 5 тестов =====
document.getElementById("btnBase").addEventListener("click", async () => {
  output.innerHTML = "Загрузка статистики по базовым 5 тестам…";
  progressWrap.style.display = 'block';
  progressInner.style.width = '0%';
  progressInner.innerText = '0%';

  try {
    const users = await loadUsers();
    let html = "<h2>Статистика по базовым 5 тестам</h2>";
    html += "<table><thead><tr><th>User</th>";
    baseTests.forEach(t=>html+=`<th>${t.id}</th>`);
    html += "<th>Итого</th></tr></thead><tbody>";

    let loaded=0;
    for(const u of users){
      let row = `<tr><td>${u.uid}</td>`;
      let totalScore=0, totalMax=0;
      for(const t of baseTests){
        const snapAttempts = await getDocs(collection(db, `results/${u.uid}/${t.id}_attempts`));
        const last = snapAttempts.empty ? null : snapAttempts.docs[snapAttempts.docs.length-1].data();
        const score = last?.score ?? 0;
        row += `<td>${score}/${t.maxPoints}</td>`;
        totalScore += score;
        totalMax += t.maxPoints;
      }
      row += `<td>${totalScore}/${totalMax}</td></tr>`;
      html += row;

      loaded++;
      const perc = Math.round(loaded/users.length*100);
      progressInner.style.width = perc+'%';
      progressInner.innerText = perc+'%';
    }

    html += "</tbody></table>";
    output.innerHTML = html;
    progressWrap.style.display = 'none';
  } catch(e){
    console.error(e);
    output.innerHTML = "<b>Ошибка загрузки базовой статистики</b>";
  }
});

// ===== Кнопка 1: Все тесты (75) =====
document.getElementById("btnAll").addEventListener("click", async () => {
  output.innerHTML = "Загрузка полной статистики всех тестов…";
  progressWrap.style.display = 'block';
  progressInner.style.width = '0%';
  progressInner.innerText = '0%';

  try {
    const users = await loadUsers();
    // Загружаем список всех тестов (base + новые)
    const allTests = [...baseTests];
    const testsSnap = await getDocs(collection(db, 'tests'));
    testsSnap.forEach(d => {
      const t = d.data();
      allTests.push({id:t.id, title:t.title, maxPoints:t.maxPoints ?? 5});
    });

    let html = "<h2>Полная статистика по всем тестам</h2>";
    html += "<table><thead><tr><th>User</th>";
    allTests.forEach(t=>html+=`<th>${t.id}</th>`);
    html += "<th>Итого</th></tr></thead><tbody>";

    let loaded=0;
    for(const u of users){
      let row = `<tr><td>${u.uid}</td>`;
      let totalScore=0, totalMax=0;
      for(const t of allTests){
        const snapAttempts = await getDocs(collection(db, `results/${u.uid}/${t.id}_attempts`));
        const last = snapAttempts.empty ? null : snapAttempts.docs[snapAttempts.docs.length-1].data();
        const score = last?.score ?? 0;
        row += `<td>${score}/${t.maxPoints}</td>`;
        totalScore += score;
        totalMax += t.maxPoints;
      }
      row += `<td>${totalScore}/${totalMax}</td></tr>`;
      html += row;

      loaded++;
      const perc = Math.round(loaded/users.length*100);
      progressInner.style.width = perc+'%';
      progressInner.innerText = perc+'%';
    }

    html += "</tbody></table>";
    output.innerHTML = html;
    progressWrap.style.display = 'none';
  } catch(e){
    console.error(e);
    output.innerHTML = "<b>Ошибка загрузки полной статистики</b>";
  }
});

// ===============================
// ======= ОСТАЛЬНЫЕ КНОПКИ =======
// ===============================

// Здесь оставляем старую рабочую логику для:
// btnVisits, btnVisitsDetailed, btnKidsVisits, btnKidsVisitsDetailed, btnExport

document.getElementById("btnVisits").addEventListener("click", async ()=>{
  output.innerHTML = "<b>Загрузка посещений…</b>";
  // Сюда вставить старый рабочий код btnVisits
});
document.getElementById("btnVisitsDetailed").addEventListener("click", async ()=>{
  output.innerHTML = "<b>Загрузка подробной статистики посещений…</b>";
  // Сюда вставить старый рабочий код btnVisitsDetailed
});
document.getElementById("btnKidsVisits").addEventListener("click", async ()=>{
  output.innerHTML = "<b>Загрузка Kids статистики…</b>";
  // Сюда вставить старый рабочий код btnKidsVisits
});
document.getElementById("btnKidsVisitsDetailed").addEventListener("click", async ()=>{
  output.innerHTML = "<b>Загрузка подробной Kids статистики…</b>";
  // Сюда вставить старый рабочий код btnKidsVisitsDetailed
});
document.getElementById("btnExport").addEventListener("click", async ()=>{
  output.innerHTML = "<b>Экспорт CSV…</b>";
  // Сюда вставить старый рабочий код btnExport
});
</script>

</body>
</html>
