<h1>Админка OGE Tests</h1>

<button id="loadOldBtn">Статистика старых тестов</button>
<button id="loadNewBtn">Статистика новых тестов</button>
<button id="diagBtn">Диагностика</button>
<button id="visitsBtn">Сводная статистика посещений</button>
<button id="visitsDetailedBtn">Подробная статистика посещений</button>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase конфиг =====
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== Тесты =====
// старые тесты
const oldTests = [
  {id: 'lvl1_test1', maxPoints: 3, title: '1. Daily Routines 1'},
  {id: 'lvl1_test2', maxPoints: 3, title: '2. Family 1'},
  {id: 'lvl1_test3', maxPoints: 3, title: '3. Shopping 1'},
  {id: 'lvl1_test4', maxPoints: 3, title: '4. Pets 1'},
  {id: 'lvl1_test5', maxPoints: 3, title: '5. Weather 1'}
];

// новые тесты (пример, полный список 75 тестов можно подставить сюда)
const newTests = [
  {id: 'test1', maxPoints: 3, title: '6. Food 1'},
  {id: 'test2', maxPoints: 3, title: '7. Hobbies 1'},
  {id: 'test3', maxPoints: 3, title: '8. Transport 1'},
  // ... добавьте все 75 тестов с правильными maxPoints и title
];

// ===== Кнопки =====
document.getElementById("loadOldBtn").onclick = () => loadStats(oldTests, 'Старая статистика тестов');
document.getElementById("loadNewBtn").onclick = () => loadStats(newTests, 'Новая статистика тестов');
document.getElementById("diagBtn").onclick = runDiag;
document.getElementById("visitsBtn").onclick = showVisits;
document.getElementById("visitsDetailedBtn").onclick = showVisitsDetailed;

// ===== Универсальная функция загрузки статистики =====
async function loadStats(tests, header) {
  const output = document.getElementById("output");
  output.innerHTML = 'Загрузка данных... ⏳';

  const resultsSnap = await getDocs(collection(db, "results"));
  const users = resultsSnap.docs.map(d => d.id);

  let html = `<h3>${header}</h3>`;
  html += '<table border="1" cellpadding="6"><tr><th>Email / UID</th>';
  tests.forEach(t => html += `<th>${t.title}</th>`);
  html += '<th>Total</th></tr>';

  for (let uid of users) {
    html += `<tr><td>${uid}</td>`;
    let totalScore = 0, totalMax = 0;

    for (let test of tests) {
      const attemptsCol = collection(db, `results/${uid}/${test.id}_attempts`);
      const snap = await getDocs(attemptsCol);

      let lastScore = 0;
      snap.forEach(doc => {
        const s = doc.data().score ?? 0;
        if (s > lastScore) lastScore = s;
      });

      html += `<td>${lastScore} / ${test.maxPoints}</td>`;
      totalScore += lastScore;
      totalMax += test.maxPoints;
    }

    html += `<td>${totalScore} / ${totalMax}</td></tr>`;
  }

  html += '</table>';
  output.innerHTML = html;
}

// ===== Диагностика =====
async function runDiag() {
  const output = document.getElementById("output");
  const resultSnap = await getDocs(collection(db, "results"));
  let html = `<h3>Диагностика</h3>`;
  html += `Всего пользователей: ${resultSnap.size}<br><br>`;

  for (let d of resultSnap.docs) {
    html += `<b>${d.id}</b><br>`;
  }
  output.innerHTML = html;
}

// ===== Сводная статистика посещений =====
async function showVisits() {
  const output = document.getElementById("output");
  output.innerHTML = 'Загрузка посещений... ⏳';
  const visitsSnap = await getDocs(collection(db, "visits"));

  const days = {};
  visitsSnap.forEach(doc => {
    const ts = doc.data().timestamp?.toDate ? doc.data().timestamp.toDate() : null;
    if(!ts) return;
    const day = ts.toISOString().split('T')[0];
    days[day] = (days[day] || 0) + 1;
  });

  let html = '<h3>Сводная статистика посещений по дням</h3>';
  html += '<table border="1" cellpadding="6"><tr><th>Дата</th><th>Посещения</th></tr>';
  Object.keys(days).sort().forEach(day => html += `<tr><td>${day}</td><td>${days[day]}</td></tr>`);
  html += '</table>';
  output.innerHTML = html;
}

// ===== Подробная статистика посещений =====
async function showVisitsDetailed() {
  const output = document.getElementById("output");
  output.innerHTML = 'Загрузка подробных данных... ⏳';
  const visitsSnap = await getDocs(collection(db, "visits"));

  const rows = [];
  visitsSnap.forEach(doc => {
    const ts = doc.data().timestamp?.toDate ? doc.data().timestamp.toDate() : null;
    if(!ts) return;
    rows.push({ip: doc.data().ip||'неизвестно', day: ts.toISOString().split('T')[0], time: ts.toTimeString().split(' ')[0]});
  });

  rows.sort((a,b)=> a.day.localeCompare(b.day));
  let html = '<h3>Подробная статистика посещений</h3>';
  html += '<table border="1" cellpadding="6"><tr><th>IP</th><th>Дата</th><th>Время</th></tr>';
  rows.forEach(r => html += `<tr><td>${r.ip}</td><td>${r.day}</td><td>${r.time}</td></tr>`);
  html += '</table>';
  output.innerHTML = html;
}
</script>
