<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Admin — OGE stats (all users, same logic as index)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;padding:18px;max-width:1200px;margin:auto}
  h1{margin-bottom:6px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  button{padding:8px 12px;font-size:14px;cursor:pointer}
  #progressWrap{margin:10px 0;display:none}
  #progressBar{height:20px;background:#e6e6e6;border-radius:6px;overflow:hidden}
  #progressInner{height:100%;width:0;background:linear-gradient(90deg,#4caf50,#81c784);text-align:center;color:white;line-height:20px;font-weight:600}
  #progressText{font-size:13px;color:#444;margin-top:6px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid #ccc;padding:6px;text-align:center}
  th{background:#f5f5f5}
  pre{white-space:pre-wrap;word-wrap:break-word;margin:0}
  .note{color:#555;font-size:13px}
</style>
</head>
<body>

<h1>Админка — статистика (все пользователи)</h1>
<p class="note">
Эта страница использует ту же логику чтения результатов, что и главная (index.html).
</p>

<div class="controls">
  <button id="btnAll">Загрузить статистику — все тесты</button>
  <button id="btnBase">Только базовые 5 тестов</button>

  <button id="btnVisits">Статистика посещений</button>
  <button id="btnVisitsDetailed">Подробная статистика посещений</button>

  <button id="btnExport">Экспорт CSV</button>
</div>

<div id="progressWrap">
  <div id="progressBar"><div id="progressInner">0%</div></div>
  <div id="progressText"></div>
</div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs,
  query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase config ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== Base tests ======
const baseTests = [
  {id:'test1', title:'Alice & Tom', maxPoints:3},
  {id:'test2', title:'Sports', maxPoints:3},
  {id:'test3', title:'Holidays', maxPoints:5},
  {id:'test4', title:'Environment', maxPoints:3},
  {id:'test5', title:'Daily Life', maxPoints:5},
];

let testsJSON = {};
let allTests = [...baseTests];
let lastTableHtml = "";

// UI
const output = document.getElementById('output');
const progressWrap = document.getElementById('progressWrap');
const progressInner = document.getElementById('progressInner');
const progressText = document.getElementById('progressText');

function showProgress(show){
  progressWrap.style.display = show ? 'block' : 'none';
}
function setProgress(percent, text=''){
  const p = Math.round(percent);
  progressInner.style.width = p + '%';
  progressInner.innerText = p + '%';
  progressText.innerText = text || '';
}

// ===== Load tests.json =====
async function loadTestsJSON(){
  try {
    const res = await fetch('tests.json');
    if(!res.ok){
      throw new Error('Не удалось загрузить файл тестов');
    }
    testsJSON = await res.json();
    allTests = [...baseTests];
    for(const level in testsJSON){
      for(const t of testsJSON[level]){
        allTests.push({
          id: t.id,
          title: t.title,
          maxPoints: t.maxPoints ?? 5
        });
      }
    }
  } catch(e){
    console.error("Ошибка загрузки тестов:", e);
    testsJSON = {};
    allTests = [...baseTests];
    alert('Не удалось загрузить тесты. Пожалуйста, попробуйте позже.');
  }
}

// === get all user ids ===
async function getAllUserIds(){
  const snap = await getDocs(collection(db, 'results'));
  return snap.docs.map(d => d.id);
}

// === get last score for test ===
async function getLastScoreFor(uid, testId){
  try {
    const attemptsCol = collection(db, "results", uid, `${testId}_attempts`);
    const snap = await getDocs(attemptsCol);
    if(snap.empty) return 0;
    const last = snap.docs[snap.docs.length - 1].data();
    return Number(last.score ?? 0);
  } catch {
    return 0;
  }
}

// === Build table ===
async function buildStatsForUsers(userIds, testsList){
  showProgress(true);
  setProgress(0, 'Запуск…');

  let html = `<h3>Статистика — ${testsList.length} тестов — пользователей: ${userIds.length}</h3>`;
  html += `<div style="overflow:auto"><table><thead><tr><th>UID</th>`;
  for(const t of testsList) html += `<th style="min-width:90px">${t.title}</th>`;
  html += `<th>Total</th></tr></thead><tbody>`;

  let processed = 0;

  for(const uid of userIds){
    const promises = testsList.map(t => getLastScoreFor(uid, t.id));
    const scores = await Promise.all(promises);

    let total = 0;
    let max = 0;

    html += `<tr><td style="text-align:left">${uid}</td>`;
    scores.forEach((s, i) => {
      const m = testsList[i].maxPoints;
      total += s;
      max += m;
      html += `<td>${s} / ${m}</td>`;
    });
    html += `<td><strong>${total} / ${max}</strong></td></tr>`;

    processed++;
    setProgress((processed/userIds.length)*100, `Обработано ${processed} / ${userIds.length}`);
    await new Promise(r => setTimeout(r, 10));
  }

  html += `</tbody></table></div>`;
  showProgress(false);
  lastTableHtml = html;
  return html;
}

// ===== Export CSV =====
function exportTableToCSV(){
  if(!lastTableHtml){
    alert('Сначала загрузите таблицу');
    return;
  }
  const tmp = document.createElement('div');
  tmp.innerHTML = lastTableHtml;
  const table = tmp.querySelector('table');
  if(!table){ alert('Таблица не найдена'); return; }

  const rows = Array.from(table.rows);
  const csv = rows.map(row =>
    Array.from(row.cells)
    .map(cell => `"${cell.innerText.replace(/"/g,'""')}"`)
    .join(',')
  ).join('\r\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'oge_stats.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// ==========================
// === VISITS STATISTICS ====
// ==========================

// — получить все посещения —
async function getAllVisits() {
  const snap = await getDocs(collection(db, 'visits'));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// — сгруппировать посещения по дням —
function groupVisitsByDay(visits) {
  const map = {};
  visits.forEach(v => {
    const date = new Date(v.timestamp).toISOString().slice(0, 10);
    map[date] = (map[date] || 0) + 1;
  });
  return map;
}

// — получить последние 100 —
async function getLatestVisits(limitCount = 100) {
  const q = query(
    collection(db, "visits"),
    orderBy("timestamp", "desc"),
    limit(limitCount)
  );
  const snap = await getDocs(q);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// — таблица: посещения по дням —
function renderVisitsByDay(map) {
  let html = `<h3>Статистика посещений по дням</h3>`;
  html += `<table><thead><tr><th>Дата</th><th>Посещений</th></tr></thead><tbody>`;

  const days = Object.keys(map).sort().reverse();
  days.forEach(day => {
    html += `<tr><td>${day}</td><td>${map[day]}</td></tr>`;
  });

  html += `</tbody></table>`;
  lastTableHtml = html;
  return html;
}

// — таблица: последние посещения —
function renderLatestVisits(list) {
  let html = `<h3>Последние ${list.length} посещений</h3>`;
  html += `<table><thead><tr>
              <th>Дата / время</th>
              <th>UID</th>
              <th>Доп. сведения</th>
           </tr></thead><tbody>`;

  list.forEach(v => {
    const dt = new Date(v.timestamp);
    const dtFormatted = `${dt.toLocaleDateString("ru-RU")} ${dt.toLocaleTimeString("ru-RU")}`;
    const extra = JSON.stringify(v, null, 2)
                    .replace(/"/g, "")
                    .replace(/\{|\}/g, "");
    html += `<tr>
              <td>${dtFormatted}</td>
              <td>${v.uid || '—'}</td>
              <td><pre>${extra}</pre></td>
            </tr>`;
  });

  html += `</tbody></table>`;
  lastTableHtml = html;
  return html;
}

// ==========================
// ====== BUTTONS ===========
// ==========================

document.getElementById('btnAll').addEventListener('click', async () => {
  output.innerHTML = 'Подготовка…';
  await loadTestsJSON();
  const users = await getAllUserIds();
  if(!users.length){
    output.innerHTML = '<b>Нет пользователей</b>';
    return;
  }
  output.innerHTML = await buildStatsForUsers(users, allTests);
});

document.getElementById('btnBase').addEventListener('click', async () => {
  output.innerHTML = 'Подготовка…';
  const users = await getAllUserIds();
  if(!users.length){
    output.innerHTML = '<b>Нет пользователей</b>';
    return;
  }
  output.innerHTML = await buildStatsForUsers(users, baseTests);
});

// === посещения по дням ===
document.getElementById('btnVisits').addEventListener('click', async () => {
  output.innerHTML = 'Загрузка статистики посещений…';
  try {
    const visits = await getAllVisits();
    if(!visits.length){
      output.innerHTML = '<b>Нет записей в visits</b>';
      return;
    }
    output.innerHTML = renderVisitsByDay(groupVisitsByDay(visits));
  } catch (error) {
    console.error('Ошибка при загрузке посещений:', error);
    output.innerHTML = '<b>Произошла ошибка при загрузке данных. Попробуйте снова.</b>';
  }
});

// === последние посещения ===
document.getElementById('btnVisitsDetailed').addEventListener('click', async () => {
  output.innerHTML = 'Загрузка последних посещений…';
  try {
    const list = await getLatestVisits(100);
    if(!list.length){
      output.innerHTML = '<b>Нет записей в visits</b>';
      return;
    }
    output.innerHTML = renderLatestVisits(list);
  } catch (error) {
    console.error('Ошибка при загрузке последних посещений:', error);
    output.innerHTML = '<b>Произошла ошибка при загрузке данных. Попробуйте снова.</b>';
  }
});

document.getElementById('btnExport').addEventListener('click', exportTableToCSV);

// preload
loadTestsJSON();
</script>

</body>
</html>
