<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Admin Stats</title>
<style>
  body { font-family: Arial; padding: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
  button { padding: 10px 20px; margin-right: 10px; margin-top: 10px; }
</style>
</head>
<body>

<h1>Админка</h1>
<button id="loadBtn">Показать статистику</button>
<button id="diagBtn">Показать диагностику</button>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "ВАШ_API_KEY",
  authDomain: "ВАШ_AUTH_DOMAIN",
  projectId: "ВАШ_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const testIds = ["test1","test2","test3","test4","test5"];
const maxPoints = { test1:3, test2:3, test3:5, test4:3, test5:5 };

document.getElementById("loadBtn").onclick = loadStats;
document.getElementById("diagBtn").onclick = runDiag;

// -------------------------------
// Загрузка статистики
// -------------------------------
async function loadStats() {
  const output = document.getElementById("output");
  output.innerHTML = "Загрузка...";

  const resultsSnap = await getDocs(collection(db, "results"));
  const allUIDs = new Set();

  // 1. UID с документами
  resultsSnap.forEach(doc => allUIDs.add(doc.id));

  // 2. UID с попытками в подколлекциях testX_attempts
  for (let uidDoc of resultsSnap.docs) {
    for (let testId of testIds) {
      const attemptsCol = collection(db, `results/${uidDoc.id}/${testId}_attempts`);
      const attemptsSnap = await getDocs(attemptsCol);
      if (!attemptsSnap.empty) allUIDs.add(uidDoc.id);
    }
  }

  const uidList = Array.from(allUIDs);

  // строим таблицу
  let html = `<table><tr><th>Email / UID</th>`;
  testIds.forEach(t => html += `<th>${t}</th>`);
  html += `<th>Total</th></tr>`;

  for (let uid of uidList) {
    html += `<tr><td>${uid}</td>`;
    let total = 0, totalMax = 0;

    for (let testId of testIds) {
      const attemptsCol = collection(db, `results/${uid}/${testId}_attempts`);
      const snap = await getDocs(attemptsCol);

      if (snap.empty) {
        html += `<td>–</td>`;
        totalMax += maxPoints[testId];
        continue;
      }

      // берём **последнюю попытку** по дате
      let lastScore = 0;
      snap.forEach(doc => {
        const data = doc.data();
        if (data.date && data.score !== undefined) {
          const score = data.score;
          if (score > lastScore) lastScore = score;
        }
      });

      total += lastScore;
      totalMax += maxPoints[testId];

      html += `<td>${lastScore} / ${maxPoints[testId]}</td>`;
    }

    html += `<td>${total} / ${totalMax}</td></tr>`;
  }

  html += `</table>`;
  output.innerHTML = html;
}

// -------------------------------
// Диагностика
// -------------------------------
async function runDiag() {
  const output = document.getElementById("output");
  let html = "<h3>Диагностика</h3>";

  const resultsSnap = await getDocs(collection(db, "results"));
  html += `Документов в results: ${resultsSnap.size}<br><br>`;

  for (let d of resultsSnap.docs) {
    html += `<b>UID: ${d.id}</b><br>`;
    for (let testId of testIds) {
      const attemptsCol = collection(db, `results/${d.id}/${testId}_attempts`);
      const attemptsSnap = await getDocs(attemptsCol);
      html += `&nbsp;&nbsp;${testId}: ${attemptsSnap.size} записей<br>`;
    }
    html += `<br>`;
  }

  output.innerHTML = html;
}
</script>
</body>
</html>
