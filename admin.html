<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Админка OGE Tests</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 1200px; }
button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
#progressContainer { width: 100%; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 10px; height: 25px; display:none; }
#progressBar { height: 100%; width: 0%; background: #4CAF50; text-align: center; color: white; line-height: 25px; font-weight: bold; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #333; padding: 6px; text-align: center; }
</style>
</head>
<body>

<h1>Админка OGE Tests</h1>

<button id="loadBtn">Показать статистику</button>
<div id="progressContainer"><div id="progressBar">0%</div></div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase конфиг ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== Настройки тестов ======
const testCount = 75;
const maxPoints = {};  // max баллы для тестов
for (let i=1;i<=75;i++) maxPoints[`test${i}`] = i<=5 ? (i%2===0?3:5) : 5; // пример, подставь реальные max

const testTitles = [
"1. Daily Routines 1","2. Family 1","3. Shopping 1","4. Pets 1","5. Weather 1",
"6. Food 1","7. Hobbies 1","8. Transport 1","9. Clothes 1","10. Toys 1",
"11. Holidays 2","12. School Life 2","13. Friends 2","14. Music 2","15. Cinema 2",
"16. Hobbies 2","17. Pets 2","18. Travel 2","19. Books 2","20. Weather 2",
"21. Food 2","22. Daily Routine 2","23. Clothes 2","24. Holidays 2","25. Environment 3",
"26. Daily Life 3","27. School Subjects 3","28. Travel and Tourism 3","29. Sports 3","30. Environment 3",
"31. Technology 3","32. Holidays 3","33. Food 3","34. Daily Routines 3","35. Family 3",
"36. Culture 3","37. Shopping 3","38. Hobbies 3","39. Science 3","40. Transport 3",
"41. Health 3","42. Festivals 3","43. Nature 3","44. Movies 3","45. Animals 3",
"46. Music 3","47. Shopping 3","48. Science 3","49. Transport 3","50. Holidays 3",
"51. Environment 4","52. Daily Life 4","53. Technology 4","54. Travel 4","55. Food 4",
"56. Sports 4","57. History 4","58. Health 4","59. Transport 4","60. Books 4",
"61. Science 4","62. Art 4","63. Media 4","64. Weather 4","65. Animals 4",
"66. Jobs 4","67. Education 4","68. Festivals 4","69. Space 4","70. Internet 4",
"71. Extra 1","72. Extra 2","73. Extra 3","74. Extra 4","75. Extra 5"
];

// ====== Кнопка ======
document.getElementById("loadBtn").onclick = loadStats;

async function loadStats() {
  const output = document.getElementById("output");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  output.innerHTML = "";
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  progressBar.innerText = "0%";

  const resultSnap = await getDocs(collection(db, "results"));
  const uidList = resultSnap.docs.map(d => d.id);

  let html = "<table><tr><th>Email / UID</th>";
  for (let title of testTitles) html += `<th>${title}</th>`;
  html += `<th>Total</th></tr>`;

  let totalSteps = uidList.length * testCount;
  let step = 0;

  for (let uid of uidList) {
    html += `<tr><td>${uid}</td>`;
    let totalScore = 0, totalMax = 0;

    for (let i=1; i<=testCount; i++) {
      const testId = `test${i}`;
      const attemptsCol = collection(db, `results/${uid}/${testId}_attempts`);
      const snap = await getDocs(attemptsCol);

      let lastScore = 0;
      snap.forEach(doc => {
        const s = doc.data().score ?? 0;
        if (s > lastScore) lastScore = s;
      });

      html += `<td>${lastScore} / ${maxPoints[testId]}</td>`;
      totalScore += lastScore;
      totalMax += maxPoints[testId];

      step++;
      let perc = Math.round(step / totalSteps * 100);
      progressBar.style.width = perc + "%";
      progressBar.innerText = perc + "%";
    }

    html += `<td>${totalScore} / ${totalMax}</td></tr>`;
  }

  html += "</table>";
  output.innerHTML = html;
  progressContainer.style.display = "none";
}

</script>
</body>
</html>
