<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–¥–º–∏–Ω–∫–∞ OGE Tests</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 1200px; }
button { padding: 10px 20px; margin: 5px; cursor: pointer; }
#output { margin-top: 20px; }
.progress-container { width: 100%; background: #eee; border-radius: 5px; overflow: hidden; margin: 10px 0; }
.progress-bar { height: 20px; width: 0%; background: linear-gradient(90deg, #4CAF50, #81C784); text-align: center; color: white; font-weight: bold; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #333; padding: 6px; text-align: center; }
</style>
</head>
<body>

<h1>–ê–¥–º–∏–Ω–∫–∞ OGE Tests</h1>

<button id="loadBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
<button id="diagBtn">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
<button id="visitsBtn">–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</button>
<button id="visitsDetailedBtn">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</button>

<div class="progress-container" style="display:none;">
  <div class="progress-bar" id="progressBar">0%</div>
</div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase –∫–æ–Ω—Ñ–∏–≥ =====
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ =====
let allTests = [];
async function loadAllTests() {
  try {
    const res = await fetch('tests.json');
    const testsJSON = await res.json();
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã –≤ –º–∞—Å—Å–∏–≤
    for (const level in testsJSON) {
      allTests.push(...testsJSON[level]);
    }
  } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ tests.json", e); }
}
await loadAllTests();

// ===== –ö–Ω–æ–ø–∫–∏ =====
document.getElementById("loadBtn").onclick = loadStats;
document.getElementById("diagBtn").onclick = runDiag;
document.getElementById("visitsBtn").onclick = showVisits;
document.getElementById("visitsDetailedBtn").onclick = showVisitsDetailed;

const progressBar = document.getElementById("progressBar");

// =============================================================
// üìå –§—É–Ω–∫—Ü–∏—è: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤ (–¢–ê–ë–õ–ò–¶–ê)
// =============================================================
async function loadStats() {
  const output = document.getElementById("output");
  output.innerHTML = "";
  document.querySelector(".progress-container").style.display = "block";
  progressBar.style.width = "0%";
  progressBar.innerText = "0%";

  const resultSnap = await getDocs(collection(db, "results"));
  const uidList = resultSnap.docs.map(d => d.id);

  let html = `<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤</h3>`;
  html += `<table><tr><th>Email / UID</th>`;
  allTests.forEach((t,i)=>html += `<th>${i+1}. ${t.title}</th>`);
  html += `<th>Total</th></tr>`;

  for (let u=0; u<uidList.length; u++) {
    const uid = uidList[u];
    html += `<tr><td>${uid}</td>`;

    let totalScore = 0;
    let totalMax = 0;

    // –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Ç–µ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const attemptsPromises = allTests.map(async t => {
      const snap = await getDocs(collection(db, `results/${uid}/${t.id}_attempts`));
      const lastScore = snap.empty ? 0 : Math.max(...snap.docs.map(d=>d.data().score??0));
      return { lastScore, maxPoints: t.maxPoints ?? 5 };
    });
    const attempts = await Promise.all(attemptsPromises);

    attempts.forEach(a => {
      html += `<td>${a.lastScore} / ${a.maxPoints}</td>`;
      totalScore += a.lastScore;
      totalMax += a.maxPoints;
    });

    html += `<td>${totalScore} / ${totalMax}</td></tr>`;

    // –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const percent = Math.round((u+1)/uidList.length*100);
    progressBar.style.width = percent + "%";
    progressBar.innerText = percent + "%";
  }

  html += "</table>";
  output.innerHTML = html;
  document.querySelector(".progress-container").style.display = "none";
}

// =============================================================
// üìå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
// =============================================================
async function runDiag() {
  const output = document.getElementById("output");
  const resultSnap = await getDocs(collection(db, "results"));
  let html = `<h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>`;
  html += `–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ results: ${resultSnap.size}<br><br>`;
  for (let d of resultSnap.docs) {
    html += `<b>${d.id}</b><br>`;
    for (let t of allTests) {
      const snap = await getDocs(collection(db, `results/${d.id}/${t.id}_attempts`));
      html += `&nbsp;&nbsp;${t.id}: ${snap.size} –∑–∞–ø–∏—Å–µ–π<br>`;
    }
    html += `<br>`;
  }
  output.innerHTML = html;
}

// =============================================================
// üìå –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π (–ø–æ –¥–Ω—è–º)
// =============================================================
async function showVisits() {
  const output = document.getElementById("output");
  output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π...";
  const visitsSnap = await getDocs(collection(db, "visits"));
  const days = {};
  visitsSnap.forEach(doc => {
    const data = doc.data();
    const ts = data.timestamp?.toDate ? data.timestamp.toDate() : null;
    if (!ts) return;
    const day = ts.toISOString().split("T")[0];
    days[day] = (days[day]||0)+1;
  });
  let html = `<h3>–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º</h3>`;
  html += `<table><tr><th>–î–∞—Ç–∞</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π</th></tr>`;
  Object.keys(days).sort().forEach(day=>html+=`<tr><td>${day}</td><td>${days[day]}</td></tr>`);
  html += "</table>";
  output.innerHTML = html;
}

// =============================================================
// üìå –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π
// =============================================================
async function showVisitsDetailed() {
  const output = document.getElementById("output");
  output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...";
  const visitsSnap = await getDocs(collection(db, "visits"));
  const rows = [];
  visitsSnap.forEach(doc=>{
    const data = doc.data();
    const ts = data.timestamp?.toDate ? data.timestamp.toDate() : null;
    if(!ts) return;
    rows.push({ ip:data.ip||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", day: ts.toISOString().split("T")[0], time: ts.toTimeString().split(" ")[0] });
  });
  rows.sort((a,b)=>a.day.localeCompare(b.day));
  let html = `<h3>–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</h3>`;
  html += `<table><tr><th>IP</th><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th></tr>`;
  rows.forEach(r=>html+=`<tr><td>${r.ip}</td><td>${r.day}</td><td>${r.time}</td></tr>`);
  html += "</table>";
  output.innerHTML = html;
}
</script>

</body>
</html>
