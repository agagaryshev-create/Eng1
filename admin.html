<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Admin Panel – English OGE Tests</title>
<style>
body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; }
button { padding: 8px 12px; margin: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #777; padding: 6px; text-align: center; }
#diagnostics { margin-top: 20px; white-space: pre-wrap; font-family: monospace; background: #f9f9f9; padding: 10px; }
</style>
</head>
<body>

<h1>Super Admin Panel – English OGE Tests</h1>
<button id="showStatsBtn">Показать статистику</button>
<button id="showDiagBtn">Показать диагностику</button>

<div id="stats"></div>
<div id="diagnostics"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6lftEB2nUifpZhE8Ays0d__BzynmvYdY",
  authDomain: "eng1-4fbc2.firebaseapp.com",
  projectId: "eng1-4fbc2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const testIds = ["test1","test2","test3","test4","test5"];
const maxPoints = { test1:3, test2:3, test3:5, test4:3, test5:5 };

const statsDiv = document.getElementById("stats");
const diagDiv = document.getElementById("diagnostics");
const showStatsBtn = document.getElementById("showStatsBtn");
const showDiagBtn = document.getElementById("showDiagBtn");

// --- Показать статистику ---
showStatsBtn.addEventListener("click", async () => {
  statsDiv.innerHTML = "Загрузка...";
  const resultsCol = collection(db, "results");
  const usersSnap = await getDocs(resultsCol);

  let rows = [];

  for (const userDoc of usersSnap.docs) {
    const uid = userDoc.id;
    let totalEarned = 0, totalMax = 0;
    let row = { uid };

    for (const test of testIds) {
      const attemptsCol = collection(db, `results/${uid}/${test}_attempts`);
      const attemptsSnap = await getDocs(attemptsCol);

      let best = 0;
      attemptsSnap.forEach(a => {
        const pts = a.data().score || 0;
        if (pts > best) best = pts;
      });

      row[test] = `${best} / ${maxPoints[test]}`;
      totalEarned += best;
      totalMax += maxPoints[test];
    }

    row.total = `${totalEarned} / ${totalMax}`;
    rows.push(row);
  }

  renderStatsTable(rows);
});

function renderStatsTable(rows) {
  let html = "<table><thead><tr><th>Email / UID</th>";
  testIds.forEach(t => { html += `<th>${t}</th>` });
  html += "<th>Total</th></tr></thead><tbody>";

  rows.forEach(r => {
    html += `<tr><td>${r.uid}</td>`;
    testIds.forEach(t => { html += `<td>${r[t]}</td>` });
    html += `<td>${r.total}</td></tr>`;
  });

  html += "</tbody></table>";
  statsDiv.innerHTML = html;
}

// --- Показать диагностику ---
showDiagBtn.addEventListener("click", async () => {
  diagDiv.innerHTML = "Загрузка диагностики...";
  const resultsCol = collection(db, "results");
  const usersSnap = await getDocs(resultsCol);
  let diagText = `Всего UID в results: ${usersSnap.size}\n\n`;

  for (const userDoc of usersSnap.docs) {
    const uid = userDoc.id;
    diagText += `UID: ${uid}\n`;
    for (const test of testIds) {
      const attemptsCol = collection(db, `results/${uid}/${test}_attempts`);
      const attemptsSnap = await getDocs(attemptsCol);
      diagText += `  ${test}: ${attemptsSnap.size} попыток\n`;
    }
    diagText += "\n";
  }

  diagDiv.innerText = diagText;
});
</script>

</body>
</html>
