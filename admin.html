<h1>–ê–¥–º–∏–Ω–∫–∞</h1>

<button id="loadBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
<button id="diagBtn">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
<button id="visitsBtn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</button>
<button id="visitsDetailedBtn">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</button>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase –∫–æ–Ω—Ñ–∏–≥ ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const testIds = ["test1","test2","test3","test4","test5"];
const maxPoints = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };

// –∫–Ω–æ–ø–∫–∏
document.getElementById("loadBtn").onclick = loadStats;
document.getElementById("diagBtn").onclick = runDiag;
document.getElementById("visitsBtn").onclick = showVisits;
document.getElementById("visitsDetailedBtn").onclick = showVisitsDetailed;

// =============================================================
// üìå –§—É–Ω–∫—Ü–∏—è: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤ (–¢–ê–ë–õ–ò–¶–ê)
// =============================================================
async function loadStats() {
  const output = document.getElementById("output");
  output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

  const resultCol = collection(db, "results");
  const resultSnap = await getDocs(resultCol);

  const uidList = resultSnap.docs.map(d => d.id);

  let html = `<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤</h3>`;
  html += `<table border="1" cellpadding="6"><tr><th>Email / UID</th>`;

  testIds.forEach(t => html += `<th>${t}</th>`);
  html += `<th>Total</th></tr>`;

  for (let uid of uidList) {
    html += `<tr><td>${uid}</td>`;

    let totalScore = 0;
    let totalMax = 0;

    for (let testId of testIds) {
      const attemptsCol = collection(db, `results/${uid}/${testId}_attempts`);
      const snap = await getDocs(attemptsCol);

      if (snap.empty) {
        html += `<td>‚Äì</td>`;
        totalMax += maxPoints[testId];
        continue;
      }

      let lastScore = 0;
      snap.forEach(doc => {
        const s = doc.data().score ?? 0;
        if (s > lastScore) lastScore = s;
      });

      html += `<td>${lastScore} / ${maxPoints[testId]}</td>`;
      totalScore += lastScore;
      totalMax += maxPoints[testId];
    }

    html += `<td>${totalScore} / ${totalMax}</td></tr>`;
  }

  html += `</table>`;
  output.innerHTML = html;
}

// =============================================================
// üìå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
// =============================================================
async function runDiag() {
  const output = document.getElementById("output");
  const resultSnap = await getDocs(collection(db, "results"));

  let html = `<h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>`;
  html += `–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ results: ${resultSnap.size}<br><br>`;

  for (let d of resultSnap.docs) {
    html += `<b>${d.id}</b><br>`;
    for (let testId of testIds) {
      const attemptsCol = collection(db, `results/${d.id}/${testId}_attempts`);
      const snap = await getDocs(attemptsCol);
      html += `&nbsp;&nbsp;${testId}: ${snap.size} –∑–∞–ø–∏—Å–µ–π<br>`;
    }
    html += `<br>`;
  }

  output.innerHTML = html;
}

// =============================================================
// üìå –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π (–ø–æ –¥–Ω—è–º)
// =============================================================
async function showVisits() {
  const output = document.getElementById("output");
  output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π...";

  const visitsSnap = await getDocs(collection(db, "visits"));

  const days = {};  // –¥–µ–Ω—å ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π

  visitsSnap.forEach(doc => {
    const data = doc.data();
    const ts = data.timestamp?.toDate ? data.timestamp.toDate() : null;
    if (!ts) return;

    const day = ts.toISOString().split("T")[0];
    days[day] = (days[day] || 0) + 1;
  });

  let html = `<h3>–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º</h3>`;
  html += `<table border="1" cellpadding="6">
           <tr><th>–î–∞—Ç–∞</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π</th></tr>`;

  Object.keys(days).sort().forEach(day => {
    html += `<tr><td>${day}</td><td>${days[day]}</td></tr>`;
  });

  html += `</table>`;
  output.innerHTML = html;
}

// =============================================================
// üìå –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π (–∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å)
// =============================================================
async function showVisitsDetailed() {
  const output = document.getElementById("output");
  output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...";

  const visitsSnap = await getDocs(collection(db, "visits"));

  const rows = [];

  visitsSnap.forEach(doc => {
    const data = doc.data();
    const ts = data.timestamp?.toDate ? data.timestamp.toDate() : null;
    if (!ts) return;

    rows.push({
      ip: data.ip || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
      ts,
      day: ts.toISOString().split("T")[0],
      time: ts.toTimeString().split(" ")[0]
    });
  });

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  rows.sort((a, b) => a.ts - b.ts);

  let html = `<h3>–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</h3>`;
  html += `<table border="1" cellpadding="6">
           <tr><th>IP</th><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th></tr>`;

  rows.forEach(r => {
    html += `<tr><td>${r.ip}</td><td>${r.day}</td><td>${r.time}</td></tr>`;
  });

  html += `</table>`;
  output.innerHTML = html;
}

</script>
