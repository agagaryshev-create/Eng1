<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Admin — OGE stats (all users, same logic as index)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;max-width:1200px;margin:auto}
    h1{margin-bottom:6px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    button{padding:8px 12px;font-size:14px;cursor:pointer}
    #progressWrap{margin:10px 0;display:none}
    #progressBar{height:20px;background:#e6e6e6;border-radius:6px;overflow:hidden}
    #progressInner{height:100%;width:0;background:linear-gradient(90deg,#4caf50,#81c784);text-align:center;color:white;line-height:20px;font-weight:600}
    #progressText{font-size:13px;color:#444;margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f5f5f5}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:0}
    .note{color:#555;font-size:13px}
  </style>
</head>
<body>

<h1>Админка — статистика (все пользователи)</h1>
<p class="note">Эта страница использует ту же логику чтения результатов, что и index.html.</p>

<div class="controls">
  <button id="btnAll">Загрузить статистику — все тесты</button>
  <button id="btnBase">Только базовые 5 тестов</button>
  <button id="btnVisits">Статистика посещений</button>
  <button id="btnVisitsDetailed">Подробная статистика посещений</button>

  <!-- === NEW BUTTONS FOR KIDS === -->
  <button id="btnKidsVisits">Kids статистика</button>
  <button id="btnKidsVisitsDetailed">Kids подробно</button>

  <button id="btnExport">Экспорт CSV</button>
</div>

<div id="progressWrap">
  <div id="progressBar"><div id="progressInner">0%</div></div>
  <div id="progressText"></div>
</div>

<div id="output"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs,
  query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ====== Firebase config ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const output = document.getElementById('output');

// === Convert timestamp helper ===
function convertTimestampToDate(timestamp) {
  return new Date(timestamp.seconds * 1000);
}

// === Group by day helper ===
function groupVisitsByDay(visits) {
  const map = {};
  visits.forEach(v => {
    const dt = convertTimestampToDate(v.timestamp);
    const date = dt.toISOString().slice(0, 10);
    map[date] = (map[date] || 0) + 1;
  });
  return map;
}

// === Render last N visits ===
function renderLatestVisits(list, title="Последние посещения") {
  let html = `<h3>${title} (${list.length})</h3>`;
  html += `<table><thead><tr>
              <th>Дата / время</th>
              <th>User-Agent</th>
           </tr></thead><tbody>`;

  list.forEach(v => {
    const dt = convertTimestampToDate(v.timestamp);
    const dtFormatted = `${dt.toLocaleDateString("ru-RU")} ${dt.toLocaleTimeString("ru-RU")}`;
    html += `<tr>
              <td>${dtFormatted}</td>
              <td><pre>${v.userAgent || "—"}</pre></td>
            </tr>`;
  });

  html += `</tbody></table>`;
  return html;
}

//
// ===============================
// ======== KIDS FUNCTIONS =======
// ===============================
//

// === Kids — all visits ===
async function getAllKidsVisits() {
  const snap = await getDocs(collection(db, 'visits_kids'));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// === Kids — last 100 ===
async function getLatestKidsVisits(limitCount = 100) {
  const qKids = query(
    collection(db, "visits_kids"),
    orderBy("timestamp", "desc"),
    limit(limitCount)
  );
  const snap = await getDocs(qKids);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// === Kids visits by day ===
document.getElementById("btnKidsVisits").addEventListener("click", async () => {
  output.innerHTML = "Загрузка статистики Kids…";

  try {
    const visits = await getAllKidsVisits();
    if (!visits.length) {
      output.innerHTML = "<b>В visits_kids нет записей</b>";
      return;
    }

    const grouped = groupVisitsByDay(visits);

    let html = `<h2>Kids — посещения по дням</h2>`;
    html += `<table><thead><tr><th>Дата</th><th>Кол-во</th></tr></thead><tbody>`;

    for (const day in grouped) {
      html += `<tr><td>${day}</td><td>${grouped[day]}</td></tr>`;
    }

    html += `</tbody></table>`;
    output.innerHTML = html;

  } catch (e) {
    console.error(e);
    output.innerHTML = "<b>Ошибка загрузки статистики Kids</b>";
  }
});

// === Kids detailed ===
document.getElementById("btnKidsVisitsDetailed").addEventListener("click", async () => {
  output.innerHTML = "Загрузка Kids подробно…";

  try {
    const list = await getLatestKidsVisits(100);
    if (!list.length) {
      output.innerHTML = "<b>Нет записей visits_kids</b>";
      return;
    }

    output.innerHTML = renderLatestVisits(list, "Kids — последние посещения");

  } catch (e) {
    console.error(e);
    output.innerHTML = "<b>Ошибка загрузки Kids подробно</b>";
  }
});


//
// ===============================
// === ORIGINAL TEST STATISTICS ==
// ===============================
//

// === ALL tests ===
async function loadAllTests() {
  output.innerHTML = "Загружаю все тесты…";

  const snap = await getDocs(collection(db, "results"));
  const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  if (!list.length) {
    output.innerHTML = "<b>Нет данных</b>";
    return;
  }

  let html = `<h2>Все тесты (${list.length})</h2>`;
  html += `<table><thead><tr>
            <th>Дата</th><th>Тест</th><th>Результат</th>
          </tr></thead><tbody>`;

  list.forEach(r => {
    const dt = convertTimestampToDate(r.timestamp);
    html += `<tr>
              <td>${dt.toLocaleString("ru-RU")}</td>
              <td>${r.testName || "?"}</td>
              <td>${r.correct}/${r.total}</td>
            </tr>`;
  });

  html += `</tbody></table>`;
  output.innerHTML = html;
}

// === Base 5 tests ===
async function loadBaseTests() {
  output.innerHTML = "Загружаю базовые тесты…";

  const qBase = query(
    collection(db, "results"),
    limit(5)
  );
  const snap = await getDocs(qBase);
  const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  if (!list.length) {
    output.innerHTML = "<b>Нет записей</b>";
    return;
  }

  output.innerHTML = renderLatestVisits(list, "Базовые 5 тестов");
}

// === Visits summary ===
async function loadVisits() {
  output.innerHTML = "Загружаю посещения…";

  const snap = await getDocs(collection(db, "visits"));
  const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  if (!list.length) {
    output.innerHTML = "<b>Нет записей</b>";
    return;
  }

  const grouped = groupVisitsByDay(list);

  let html = `<h2>Посещения по дням</h2>`;
  html += `<table><thead><tr><th>Дата</th><th>Кол-во</th></tr></thead><tbody>`;

  for (const day in grouped) {
    html += `<tr><td>${day}</td><td>${grouped[day]}</td></tr>`;
  }

  html += `</tbody></table>`;
  output.innerHTML = html;
}

// === Visits detailed ===
async function loadVisitsDetailed() {
  output.innerHTML = "Загружаю подробно…";

  const q = query(
    collection(db, "visits"),
    orderBy("timestamp", "desc"),
    limit(100)
  );
  const snap = await getDocs(q);
  const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  output.innerHTML = renderLatestVisits(list, "Последние 100 посещений");
}

// === Export CSV ===
function exportCSV() {
  const table = output.querySelector("table");
  if (!table) {
    alert("Сначала загрузите данные");
    return;
  }

  let csv = "";
  [...table.rows].forEach(row => {
    const cells = [...row.cells].map(c => `"${c.innerText.replace(/"/g, '""')}"`);
    csv += cells.join(",") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "export.csv";
  a.click();
  URL.revokeObjectURL(url);
}

//
// ===============================
// ========= BUTTONS =============
// ===============================
//

document.getElementById("btnAll").addEventListener("click", loadAllTests);
document.getElementById("btnBase").addEventListener("click", loadBaseTests);
document.getElementById("btnVisits").addEventListener("click", loadVisits);
document.getElementById("btnVisitsDetailed").addEventListener("click", loadVisitsDetailed);
document.getElementById("btnExport").addEventListener("click", exportCSV);

</script>

</body>
</html>
