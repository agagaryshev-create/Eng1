<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Admin Stats</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    button { padding: 10px 20px; margin-right: 10px; }
  </style>
</head>
<body>

<h1>–ê–¥–º–∏–Ω–∫–∞</h1>
<button id="loadBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
<button id="diagBtn">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>

<div id="output"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs,
    doc, listCollections
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
    authDomain: "engtestoge.firebaseapp.com",
    projectId: "engtestoge"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const testIds = ["test1", "test2", "test3", "test4", "test5"];
  const maxPoints = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };

  document.getElementById("loadBtn").onclick = loadStats;
  document.getElementById("diagBtn").onclick = runDiag;

  // -------------------------------
  // üìå –§—É–Ω–∫—Ü–∏—è: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  // -------------------------------
  async function loadStats() {
    const output = document.getElementById("output");
    output.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    const resultCol = collection(db, "results");
    const resultSnap = await getDocs(resultCol);

    let allUIDs = new Set();

    // 1Ô∏è‚É£ UID –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ results/
    resultSnap.forEach(doc => allUIDs.add(doc.id));

    // 2Ô∏è‚É£ –ü–æ–∏—Å–∫ UID, –∫–æ—Ç–æ—Ä—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –∫–∞–∫ –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏–∏
    for (let uidDoc of resultSnap.docs) {
      const subcols = await listCollections(uidDoc.ref);
      if (subcols.length > 0) allUIDs.add(uidDoc.id);
    }

    // 3Ô∏è‚É£ –í–∞–∂–Ω–æ–µ –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏–µ: –ø–æ–∏—Å–∫ UID —á–µ—Ä–µ–∑ –≤—Å–µ –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏–∏ testX_attempts
    for (let testId of testIds) {
      const sub = collection(db, `results`);
      const docs = await getDocs(sub);

      for (let uidDoc of docs.docs) {
        const attemptsCol = collection(db, `results/${uidDoc.id}/${testId}_attempts`);
        const attemptsSnap = await getDocs(attemptsCol);
        if (!attemptsSnap.empty) {
          allUIDs.add(uidDoc.id);
        }
      }
    }

    // üìå –¢–µ–ø–µ—Ä—å –≤ allUIDs –ø–æ–ø–∞–¥—ë—Ç –¥–∞–∂–µ UID –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –Ω–æ —Å –ø–æ–ø—ã—Ç–∫–∞–º–∏
    const uidList = Array.from(allUIDs);

    let html = `<table><tr><th>Email / UID</th>`;
    testIds.forEach(t => html += `<th>${t}</th>`);
    html += `<th>Total</th></tr>`;

    for (let uid of uidList) {
      html += `<tr><td>${uid}</td>`;

      let total = 0;
      let totalMax = 0;

      for (let testId of testIds) {
        const attemptsCol = collection(db, `results/${uid}/${testId}_attempts`);
        const snap = await getDocs(attemptsCol);

        if (snap.empty) {
          html += `<td>‚Äì</td>`;
          continue;
        }

        let lastScore = 0;
        snap.forEach(doc => {
          const s = doc.data().score ?? 0;
          if (s > lastScore) lastScore = s;
        });

        total += lastScore;
        totalMax += maxPoints[testId];

        html += `<td>${lastScore} / ${maxPoints[testId]}</td>`;
      }

      html += `<td>${total} / ${totalMax}</td></tr>`;
    }

    html += `</table>`;
    output.innerHTML = html;
  }

  // ---------------------------
  // üìå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
  // ---------------------------
  async function runDiag() {
    const output = document.getElementById("output");
    let html = "<h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>";

    const resSnap = await getDocs(collection(db, "results"));

    html += `–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ UID –≤ results: ${resSnap.size}<br><br>`;

    for (let d of resSnap.docs) {
      html += `<b>${d.id}</b><br>`;
      const subcols = await listCollections(d.ref);
      for (let col of subcols) {
        html += `&nbsp;&nbsp;${col.id}<br>`;
      }
      html += `<br>`;
    }

    output.innerHTML = html;
  }

</script>

</body>
</html>
