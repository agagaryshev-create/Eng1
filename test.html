<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OGE Test</title>
<style>
body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; line-height: 1.6; }
h1 { text-align: center; }
.question { margin-bottom: 15px; }
.btn { padding: 10px 15px; border: 1px solid #333; cursor: pointer; margin-top: 20px; display: inline-block; }
input[type="text"] { width: 200px; padding: 5px; margin-top: 5px; }
#result { margin-top: 20px; font-size: 20px; font-weight: bold; }
#back-btn { margin-top: 30px; padding: 8px 12px; cursor: pointer; border: 1px solid #333; background-color: #f0f0f0; }
</style>
</head>
<body>

<h1 id="test-title">Тест</h1>
<div id="test-text"></div>
<div id="questions"></div>

<div class="btn" id="check-btn">Проверить</div>
<div id="result"></div>
<button id="back-btn">← Вернуться на главную</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, user => { currentUser = user; });

// ===== Получаем id теста из URL =====
const urlParams = new URLSearchParams(window.location.search);
const testId = urlParams.get('id');

// ===== Загружаем JSON =====
let tests = {};
async function loadTests() {
  try {
    const res = await fetch('tests.json');
    tests = await res.json();
    renderTest();
  } catch(err) {
    console.error("Ошибка загрузки JSON:", err);
  }
}
await loadTests();

// ===== Найти тест по id =====
function findTestById(id) {
  for(const lvl of Object.keys(tests)) {
    const arr = tests[lvl];
    if(!Array.isArray(arr)) continue;
    for(const t of arr) {
      if(t.id === id) return t;
    }
  }
  return null;
}

// ===== Отобразить тест =====
function renderTest() {
  const test = findTestById(testId);
  if(!test) {
    document.getElementById('test-title').textContent = "Тест не найден";
    return;
  }

  document.getElementById('test-title').textContent = test.title;
  document.getElementById('test-text').textContent = test.text || '';

  const questionsDiv = document.getElementById('questions');
  questionsDiv.innerHTML = '';

  test.questions.forEach((q, i) => {
    const qDiv = document.createElement('div');
    qDiv.className = 'question';
    qDiv.innerHTML = `<p>${i+1}. ${q.text}</p>`;

    if(q.type === 'radio') {
      q.options.forEach(opt => {
        const idOpt = `q${i}_${opt}`;
        qDiv.innerHTML += `
          <label>
            <input type="radio" name="q${i}" value="${opt}"> ${opt}
          </label><br>
        `;
      });
    } else if(q.type === 'text') {
      qDiv.innerHTML += `<input type="text" name="q${i}" placeholder="ваш ответ">`;
    }

    questionsDiv.appendChild(qDiv);
  });

  // Проверка теста
  document.getElementById('check-btn').onclick = async function() {
    let score = 0;

    test.questions.forEach((q, i) => {
      if(q.type === 'radio') {
        const ans = document.querySelector(`input[name="q${i}"]:checked`);
        if(ans && ans.value === q.answer) score++;
      } else if(q.type === 'text') {
        const ans = document.querySelector(`input[name="q${i}"]`).value.trim().toLowerCase();
        if(ans === q.answer.toLowerCase()) score++;
      }
    });

    document.getElementById('result').innerText = `Ваш результат: ${score} / ${test.maxPoints}`;

    if(!currentUser) {
      alert("Чтобы сохранить результат — войдите в систему!");
      return;
    }

    const colRef = collection(db, "results", currentUser.uid, `${test.id}_attempts`);
    await addDoc(colRef, { score, date: new Date() });
  };
}

// ===== Кнопка возврата =====
document.getElementById('back-btn').addEventListener('click', () => {
  if(window.opener) {
    window.opener.location.reload();
    window.close();
  } else {
    window.location.href = "oge-tests.html";
  }
});
</script>

</body>
</html>
