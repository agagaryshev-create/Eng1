<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>English OGE Tests ‚Äì –ì–ª–∞–≤–Ω–∞—è</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
h1 { text-align: center; }
.auth-box { max-width: 400px; margin: 0 auto; }
input, button { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; }
button { cursor: pointer; }

.menu { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
.menu .card {
  flex: 1 1 200px;
  max-width: 250px;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: center;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  text-decoration: none; color: black;
}
.menu .card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

#stats { margin-top: 30px; overflow-x: auto; }
#stats table { width: 100%; border-collapse: collapse; }
#stats th, #stats td { border: 1px solid #333; padding: 8px; text-align: center; }
.progress-container { background: #eee; border-radius: 5px; overflow: hidden; height: 20px; margin-top: 5px; }
.progress-bar { height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); width: 0%; text-align: center; color: white; font-weight: bold; }

#scoreChart { max-width: 800px; margin-top: 30px; display: none; }

@media(max-width:600px){
  .menu { flex-direction: column; align-items: center; }
}
</style>
</head>
<body>

<h1>English OGE Tests</h1>

<div style="margin-top: 20px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
  <button onclick="location.href='OGE_English_Guide.html'" 
          style="padding:10px 20px; font-size:16px; cursor:pointer;">
    üìñ –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –û–ì–≠
  </button>
  <button onclick="location.href='oge-tests.html'" 
          style="padding:10px 20px; font-size:16px; cursor:pointer;">
    üìù –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ—Å—Ç–∞–º
  </button>
</div>
<p style="font-size:14px; color:#555; max-width:500px; margin: 10px auto;">
  –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç—ã –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É –¥–ª—è –û–ì–≠. –¢–µ—Å—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ —É—Ä–æ–≤–Ω—è–º –∏ –≤–∫–ª—é—á–∞—é—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ 70 —Ç–µ—Å—Ç–æ–≤.
</p>

<div class="auth-box" id="auth">
  <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="register-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <button id="login-btn">–í–æ–π—Ç–∏</button>
  <button id="logout-btn" style="display:none;">–í—ã–π—Ç–∏</button>
  <div id="auth-msg"></div>
</div>

<div class="menu" id="test-menu"></div>

<div id="stats">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</div>
<canvas id="scoreChart"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ===== Firebase –∫–æ–Ω—Ñ–∏–≥ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è =====
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMsg = document.getElementById("auth-msg");
const statsDiv = document.getElementById("stats");
const chartCanvas = document.getElementById("scoreChart");

let scoreChartInstance = null;
let testsJSON = {}; // —Å—é–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º tests.json

async function loadTestsJSON(){
  try {
    const res = await fetch('tests.json');
    testsJSON = await res.json();
  } catch(e){ console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ tests.json", e); }
}
await loadTestsJSON();

// ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è =====
registerBtn.addEventListener("click", async () => {
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    const uid = userCredential.user.uid;
    authMsg.innerText = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!";
    await setDoc(doc(db, "results", uid), { created: new Date() });
  } catch (err) { authMsg.innerText = "–û—à–∏–±–∫–∞: " + err.message; }
});

// ===== –í—Ö–æ–¥ =====
loginBtn.addEventListener("click", async () => {
  try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); authMsg.innerText = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!"; } 
  catch (err) { authMsg.innerText = "–û—à–∏–±–∫–∞: " + err.message; }
});

// ===== –í—ã—Ö–æ–¥ =====
logoutBtn.addEventListener("click", async () => { try { await signOut(auth); } catch (err) { alert("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: " + err.message); } });

// ===== –°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π =====
onAuthStateChanged(auth, async (user) => {
  if(user){
    emailInput.style.display="none";
    passwordInput.style.display="none";
    registerBtn.style.display="none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline";
    authMsg.innerText="–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: "+user.email;
    await showFullStats(user.uid);
  } else {
    emailInput.style.display="inline";
    passwordInput.style.display="inline";
    registerBtn.style.display="inline";
    loginBtn.style.display="inline";
    logoutBtn.style.display="none";
    statsDiv.innerText="–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.";
    chartCanvas.style.display="none";
  }
});

// ===== –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Å–µ–º —Ç–µ—Å—Ç–∞–º =====
async function showFullStats(uid){
  const chartLabels = [], chartData = [];
  let totalScore=0, totalMax=0;
  let html="<h2>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2><table><tr><th>–¢–µ—Å—Ç</th><th>–ë–∞–ª–ª—ã</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th></tr>";

  for(const level in testsJSON){
    for(const test of testsJSON[level]){
      const attemptsCol = collection(db,"results",uid,`${test.id}_attempts`);
      const snap = await getDocs(attemptsCol);
      const lastScore = snap.empty ? 0 : snap.docs[snap.docs.length-1].data().score ?? 0;
      const maxScore = test.maxPoints ?? 5;
      const percent = Math.round(lastScore/maxScore*100);

      totalScore += lastScore;
      totalMax += maxScore;

      html+=`<tr><td>${test.title}</td><td>${lastScore} / ${maxScore}</td>
        <td><div class="progress-container">
          <div class="progress-bar" style="width:${percent}%">${percent}%</div>
        </div></td></tr>`;

      chartLabels.push(test.title);
      chartData.push(lastScore);
    }
  }

  html+=`<tr><td><strong>–ò—Ç–æ–≥–æ</strong></td><td>${totalScore} / ${totalMax}</td><td></td></tr></table>`;
  statsDiv.innerHTML = html;

  if(chartData.length>0){
    chartCanvas.style.display="block";
    if(scoreChartInstance) scoreChartInstance.destroy();
    scoreChartInstance = new Chart(chartCanvas,{
      type:'line',
      data:{ labels:chartLabels, datasets:[{label:'–ë–∞–ª–ª—ã', data:chartData, borderColor:'blue', fill:false, tension:0.2}] },
      options:{ responsive:true }
    });
  } else chartCanvas.style.display="none";
}
</script>

</body>
</html>
