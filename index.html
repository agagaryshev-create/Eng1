<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>English OGE Tests ‚Äì –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; line-height: 1.6; }
h1 { text-align: center; }
.menu { margin-top: 30px; }
.menu a { display: block; padding: 10px; margin-bottom: 10px; border: 1px solid #333; text-decoration: none; color: black; width: 250px; }
#stats, #charts { margin-top: 30px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
input, button { padding: 5px; margin: 5px 0; }
</style>
</head>
<body>

<h1>English OGE Tests</h1>
<div style="margin-top: 20px;">
  <button onclick="location.href='OGE_English_Guide.html'" 
          style="padding:10px 20px; font-size:16px; cursor:pointer;">
    üìñ –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –û–ì–≠
  </button>
  <p style="font-size:14px; color:#555; max-width:500px;">
    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—É—é —à–ø–∞—Ä–≥–∞–ª–∫—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –û–ì–≠ –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É: –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –ø–∏—Å—å–º–æ –∏ —É—Å—Ç–Ω–∞—è —á–∞—Å—Ç—å. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —ç–∫–∑–∞–º–µ–Ω–æ–º.
  </p>
</div>
<div id="auth">
  <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
  <button id="register-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <button id="login-btn">–í–æ–π—Ç–∏</button>
  <button id="logout-btn" style="display:none;">–í—ã–π—Ç–∏</button>
  <div id="auth-msg"></div>
</div>

<div class="menu">
  <a href="test1.html" target="_blank">Test 1: Alice & Tom</a>
  <a href="test2.html" target="_blank">Test 2: Sports</a>
  <a href="test3.html" target="_blank">Test 3: Holidays</a>
  <a href="test4.html" target="_blank">Test 4: Environment</a>
  <a href="test5.html" target="_blank">Test 5: Daily Life</a>
</div>

<div id="stats">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</div>
<canvas id="scoreChart" style="max-width: 800px; margin-top: 30px;"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ====== Firebase –∫–æ–Ω—Ñ–∏–≥ ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// –≠–ª–µ–º–µ–Ω—Ç—ã
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMsg = document.getElementById("auth-msg");
const statsDiv = document.getElementById("stats");
const chartCanvas = document.getElementById("scoreChart");

import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registerBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;

    // –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ results/UID
    await setDoc(doc(db, "results", uid), { email: email });

    authMsg.innerText = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!";
  } catch (err) {
    authMsg.innerText = "–û—à–∏–±–∫–∞: " + err.message;
  }
});

// –í—Ö–æ–¥
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    authMsg.innerText = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!";
  } catch (err) {
    authMsg.innerText = "–û—à–∏–±–∫–∞: " + err.message;
  }
});

// –í—ã—Ö–æ–¥
logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
  } catch (err) {
    alert("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: " + err.message);
  }
});

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
onAuthStateChanged(auth, async (user) => {
  if (user) {
    emailInput.style.display = "none";
    passwordInput.style.display = "none";
    registerBtn.style.display = "none";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline";
    authMsg.innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + user.email;
    await showFullStats(user.uid);
  } else {
    emailInput.style.display = "inline";
    passwordInput.style.display = "inline";
    registerBtn.style.display = "inline";
    loginBtn.style.display = "inline";
    logoutBtn.style.display = "none";
    statsDiv.innerText = "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.";
    chartCanvas.style.display = "none";
  }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∞
// –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ Chart
async function showFullStats(uid) {
  const testIds = ["test1", "test2", "test3", "test4", "test5"];
  const maxPointsByTest = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };
  const testsData = {};

  const chartLabels = [];
  const chartData = [];

  let totalLastAttempts = 0;
  let totalMaxPoints = 0;

  for (let testId of testIds) {
    const attemptsCol = collection(db, "results", uid, `${testId}_attempts`);
    const attemptsSnapshot = await getDocs(attemptsCol);

    if (attemptsSnapshot.empty) continue;

    const attemptsArray = attemptsSnapshot.docs.map(doc => {
      const data = doc.data();
      return {
        score: data.score ?? 0,
        date: data.date?.toDate ? data.date.toDate() : null
      };
    });

    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
    attemptsArray.sort((a, b) => a.date - b.date);

    testsData[testId] = attemptsArray;

    // --- –ø–æ–¥—Å—á—ë—Ç –æ–±—â–µ–π —Å—É–º–º—ã –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ ---
    const lastAttempt = attemptsArray[attemptsArray.length - 1];
    totalLastAttempts += lastAttempt.score;
    totalMaxPoints += maxPointsByTest[testId] ?? 0;

    // --- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ ---
    attemptsArray.forEach((a, idx) => {
      const dateStr = a.date ? a.date.toLocaleString() : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      chartLabels.push(`${testId}${idx === attemptsArray.length -1 ? ' (–ø–æ—Å–ª–µ–¥–Ω—è—è)' : ''} (${dateStr.split(',')[0]})`);
      chartData.push(a.score);
    });
  }

  // --- –¢–∞–±–ª–∏—Ü–∞ ---
  let html = "<h2>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>";

  for (let testId of testIds) {
    html += `<h3>${testId}</h3>`;

    if (!testsData[testId] || testsData[testId].length === 0) {
      html += "<p>–ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫</p>";
      continue;
    }

    html += `<table><tr><th>–î–∞—Ç–∞</th><th>–ë–∞–ª–ª—ã</th></tr>`;
    testsData[testId].forEach((a, idx, arr) => {
      const dateStr = a.date ? a.date.toLocaleString() : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      const isLast = idx === arr.length - 1 ? ' ‚Üê –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞' : '';
      html += `<tr><td>${dateStr}</td><td>${a.score} / ${maxPointsByTest[testId]}${isLast}</td></tr>`;
    });
    html += "</table>";
  }

  html += `<p><strong>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ø—ã—Ç–æ–∫: ${totalLastAttempts} / ${totalMaxPoints}</strong></p>`;
  statsDiv.innerHTML = html;

  // --- –ì—Ä–∞—Ñ–∏–∫ ---
  if (chartData.length > 0) {
    chartCanvas.style.display = "block";

    if (scoreChartInstance) scoreChartInstance.destroy();

    scoreChartInstance = new Chart(chartCanvas, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [{
          label: '–ë–∞–ª–ª—ã',
          data: chartData,
          borderColor: 'blue',
          fill: false,
          tension: 0.2
        }]
      },
      options: { responsive: true }
    });

  } else {
    chartCanvas.style.display = "none";
  }
}


</script>

</body>
</html>
