<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ====== Firebase конфиг ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Глобальные переменные для консоли (опционально)
window.auth = auth;
window.db = db;

// Элементы страницы
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMsg = document.getElementById("auth-msg");
const statsDiv = document.getElementById("stats");
const chartCanvas = document.getElementById("scoreChart");

// ===== Регистрация, вход, выход =====
registerBtn.addEventListener("click", async () => {
  try {
    await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    authMsg.innerText = "Регистрация успешна!";
  } catch (err) { authMsg.innerText = "Ошибка: " + err.message; }
});

loginBtn.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    authMsg.innerText = "Вход выполнен!";
  } catch (err) { authMsg.innerText = "Ошибка: " + err.message; }
});

logoutBtn.addEventListener("click", async () => {
  try { await signOut(auth); } 
  catch (err) { alert("Ошибка выхода: " + err.message); }
});

// ===== Отслеживаем авторизацию =====
onAuthStateChanged(auth, async (user) => {
  if (user) {
    emailInput.style.display = "none";
    passwordInput.style.display = "none";
    registerBtn.style.display = "none";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline";
    authMsg.innerText = "Вы вошли как: " + user.email;

    await showFullStats(user.uid); // вызываем рабочую функцию
  } else {
    emailInput.style.display = "inline";
    passwordInput.style.display = "inline";
    registerBtn.style.display = "inline";
    loginBtn.style.display = "inline";
    logoutBtn.style.display = "none";
    statsDiv.innerText = "Войдите, чтобы увидеть статистику.";
    chartCanvas.style.display = "none";
  }
});

// ===== Рабочая функция showFullStats =====
async function showFullStats(uid) {
  const testIds = ["test1","test2","test3","test4","test5"];
  let totalMaxScore = 0;
  let totalScore = 0;
  let tableHTML = "<h2>История результатов</h2>";

  const chartLabels = [];
  const chartData = [];

  for (let testId of testIds) {
    // Путь к документу пользователя + тест
    const testDocRef = doc(db, "results", uid, testId);
    const attemptsCol = collection(testDocRef, "attempts"); // подколлекция "attempts"

    let snapshot;
    try {
      snapshot = await getDocs(attemptsCol);
    } catch (err) {
      console.error(`Ошибка получения данных для ${testId}:`, err);
      tableHTML += `<p>Не удалось загрузить данные для ${testId}</p>`;
      continue;
    }

    let maxPoints = 0;
    switch(testId){
      case "test1": maxPoints = 3; break;
      case "test2": maxPoints = 3; break;
      case "test3": maxPoints = 5; break;
      case "test4": maxPoints = 3; break;
      case "test5": maxPoints = 5; break;
    }

    tableHTML += `<h3>${testId}</h3>`;

    if (snapshot.empty) {
      tableHTML += "<p>Нет попыток</p>";
      continue;
    }

    tableHTML += `<table><tr><th>Дата</th><th>Баллы</th></tr>`;

    snapshot.forEach(doc => {
      const data = doc.data();
      let dateStr = "неизвестно";
      if (data.date) {
        try {
          const dateObj = data.date.toDate ? data.date.toDate() : new Date(data.date);
          dateStr = dateObj.toLocaleString();
        } catch (e) { console.warn("Неверный формат даты:", data.date); }
      }
      const score = data.score ?? 0;
      tableHTML += `<tr><td>${dateStr}</td><td>${score} / ${maxPoints}</td></tr>`;

      chartLabels.push(`${testId} (${dateStr.split(',')[0]})`);
      chartData.push(score);

      totalScore += score;
      totalMaxScore += maxPoints;
    });

    tableHTML += "</table>";
  }

  tableHTML += `<p><strong>Общий результат (сумма всех попыток): ${totalScore} / ${totalMaxScore}</strong></p>`;
  statsDiv.innerHTML = tableHTML;

  // Строим график
  if (chartData.length > 0) {
    chartCanvas.style.display = "block";
    new Chart(chartCanvas, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Баллы',
          data: chartData,
          fill: false,
          borderColor: 'blue',
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Прогресс пользователя' }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  } else {
    chartCanvas.style.display = "none";
  }
}
</script>
