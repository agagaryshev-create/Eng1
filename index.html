async function showFullStats(uid) {
  const attemptsCol = collection(db, "results", uid, "attempts");
  const snapshot = await getDocs(attemptsCol);

  if (snapshot.empty) {
    statsDiv.innerText = "Нет попыток";
    return;
  }

  let tableHTML = "<h2>История результатов</h2>";
  const chartLabels = [];
  const chartData = [];
  let totalScore = 0;
  let totalMaxScore = 0;

  const maxPointsByTest = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };

  // создаём объект для группировки по тестам
  const testsData = {};

  snapshot.forEach(doc => {
    const data = doc.data();
    const testId = data.testId || "unknown"; // должно быть в каждой попытке
    const score = data.score ?? 0;
    const dateStr = data.date?.toDate ? data.date.toDate().toLocaleString() : "неизвестно";

    if (!testsData[testId]) testsData[testId] = [];
    testsData[testId].push({ dateStr, score });

    totalScore += score;
    totalMaxScore += maxPointsByTest[testId] ?? 0;

    chartLabels.push(`${testId} (${dateStr.split(',')[0]})`);
    chartData.push(score);
  });

  for (let testId in maxPointsByTest) {
    tableHTML += `<h3>${testId}</h3>`;
    if (!testsData[testId] || testsData[testId].length === 0) {
      tableHTML += "<p>Нет попыток</p>";
      continue;
    }

    tableHTML += `<table><tr><th>Дата</th><th>Баллы</th></tr>`;
    testsData[testId].forEach(item => {
      tableHTML += `<tr><td>${item.dateStr}</td><td>${item.score} / ${maxPointsByTest[testId]}</td></tr>`;
    });
    tableHTML += "</table>";
  }

  tableHTML += `<p><strong>Общий результат: ${totalScore} / ${totalMaxScore}</strong></p>`;
  statsDiv.innerHTML = tableHTML;

  // График
  if (chartData.length > 0) {
    chartCanvas.style.display = "block";
    new Chart(chartCanvas, {
      type: 'line',
      data: { labels: chartLabels, datasets: [{ label: 'Баллы', data: chartData, borderColor: 'blue', fill: false, tension: 0.2 }] },
      options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Прогресс пользователя' } }, scales: { y: { beginAtZero: true } } }
    });
  } else {
    chartCanvas.style.display = "none";
  }
}
