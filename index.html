<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>English OGE Tests ‚Äì –ì–ª–∞–≤–Ω–∞—è</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
h1 { text-align: center; }

.auth-box { max-width: 400px; margin: 0 auto; }
input, button { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; }
button { cursor: pointer; }

.menu { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
.menu .card {
  flex: 1 1 200px;
  max-width: 250px;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: center;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  text-decoration: none; color: black;
}
.menu .card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

#stats-container { margin-top: 30px; overflow-x: auto; }
#stats-container table { width: 100%; border-collapse: collapse; }
#stats-container th, #stats-container td { border: 1px solid #333; padding: 8px; text-align: center; }

.progress-container { background: #eee; border-radius: 5px; overflow: hidden; height: 20px; margin-top: 5px; }
.progress-bar { height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); width: 0%; text-align: center; color: white; font-weight: bold; }

#scoreChart { max-width: 800px; margin-top: 30px; display: none; }

@media(max-width:600px){
  .menu { flex-direction: column; align-items: center; }
}
</style>
</head>
<body>

<h1>English OGE Tests</h1>

<div style="margin-top: 20px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
  <button onclick="location.href='kids.html'" style="padding:10px 20px; font-size:16px;"> üê∂ –ê–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è –¥–µ—Ç–µ–π</button>
  <button onclick="location.href='OGE_English_Guide.html'" style="padding:10px 20px; font-size:16px;">üìñ –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –û–ì–≠</button>
  <button onclick="location.href='oge-tests.html'" style="padding:10px 20px; font-size:16px;">üìù –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ—Å—Ç–∞–º</button>
</div>
<p style="font-size:14px; color:#555; max-width:500px; margin: 10px auto;">
  –¢–µ—Å—Ç—ã –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É –¥–ª—è –û–ì–≠. –°—é–¥–∞ –≤—Ö–æ–¥—è—Ç –±–∞–∑–æ–≤—ã–µ 5 —Ç–µ—Å—Ç–æ–≤ –∏ –Ω–æ–≤—ã–µ 70 —Ç–µ—Å—Ç–æ–≤ –∏–∑ JSON.
</p>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div class="auth-box" id="auth">
  <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="register-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <button id="login-btn">–í–æ–π—Ç–∏</button>
  <button id="logout-btn" style="display:none;">–í—ã–π—Ç–∏</button>
  <div id="auth-msg"></div>
</div>

<!-- –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã -->
<h2>–ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã</h2>
<div class="menu" id="base-tests">
  <a href="test1.html" class="card" target="_blank">1. Alice & Tom</a>
  <a href="test2.html" class="card" target="_blank">2. Sports</a>
  <a href="test3.html" class="card" target="_blank">3. Holidays</a>
  <a href="test4.html" class="card" target="_blank">4. Environment</a>
  <a href="test5.html" class="card" target="_blank">5. Daily Life</a>
</div>

<!-- –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∏–∑ JSON -->
<h2>–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã</h2>
<div class="menu" id="json-tests"></div>

<button id="show-stats-btn" style="margin-top:20px;">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
<div id="stats-loader" style="display:none; margin-top:10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏‚Ä¶ ‚è≥</div>
<div id="stats-container"></div>
<canvas id="scoreChart"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, doc, setDoc, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { 
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
  signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

// ===== Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// === –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ü–û–°–ï–©–ï–ù–ò–ô ===
async function logVisit() {
  try {
    await addDoc(collection(db, "visits"), {
      timestamp: serverTimestamp(),
      page: window.location.pathname,
      userAgent: navigator.userAgent
    });
    console.log("Visit logged");
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", e);
  }
}
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤
logVisit();

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMsg = document.getElementById("auth-msg");

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const statsBtn = document.getElementById("show-stats-btn");
const statsLoader = document.getElementById("stats-loader");
const statsDiv = document.getElementById("stats-container");
const chartCanvas = document.getElementById("scoreChart");
let scoreChartInstance = null;

// JSON —Ç–µ—Å—Ç—ã
let testsJSON = {};

async function loadTestsJSON(){
  try {
    const res = await fetch('tests.json');
    testsJSON = await res.json();
    renderJSONTests();
  } catch(e){ console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ tests.json", e); }
}
await loadTestsJSON();

// ===== –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ JSON —Ç–µ—Å—Ç–æ–≤ =====
function renderJSONTests(){
  const container = document.getElementById("json-tests");
  container.innerHTML = '';
  let counter = 6;
  for(const level in testsJSON){
    for(const test of testsJSON[level]){
      const a = document.createElement('a');
      a.href = `test.html?id=${test.id}`;
      a.target = "_blank";
      a.className = 'card';
      a.innerText = `${counter}. ${test.title} (–£—Ä–æ–≤–µ–Ω—å ${test.level})`;
      container.appendChild(a);
      counter++;
    }
  }
}

// ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è =====
registerBtn.addEventListener("click", async () => {
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    const uid = userCredential.user.uid;
    authMsg.innerText = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!";
    await setDoc(doc(db, "results", uid), { created: new Date() });
  } catch (err) { authMsg.innerText = "–û—à–∏–±–∫–∞: " + err.message; }
});
loginBtn.addEventListener("click", async () => {
  try { 
    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); 
    authMsg.innerText = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!"; 
  } 
  catch (err) { authMsg.innerText = "–û—à–∏–±–∫–∞: " + err.message; }
});
logoutBtn.addEventListener("click", async () => { 
  try { await signOut(auth); } catch (err) { alert("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: " + err.message); } 
});

onAuthStateChanged(auth, async (user) => {
  if(user){
    emailInput.style.display="none";
    passwordInput.style.display="none";
    registerBtn.style.display="none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline";
    authMsg.innerText="–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: "+user.email;
  } else {
    emailInput.style.display="inline";
    passwordInput.style.display="inline";
    registerBtn.style.display="inline";
    loginBtn.style.display="inline";
    logoutBtn.style.display="none";
    statsDiv.innerHTML = '';
    chartCanvas.style.display="none";
  }
});

statsBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if(!user) { alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }
  statsLoader.style.display = 'block';
  await showFullStats(user.uid);
  statsLoader.style.display = 'none';
});

// ===== –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ =====
async function showFullStats(uid){
  const chartLabels = [], chartData = [];
  let totalScore=0, totalMax=0;
  let html="<h2>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2><table><tr><th>–¢–µ—Å—Ç</th><th>–ë–∞–ª–ª—ã</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th></tr>";

  const baseTests = [
    {id:'test1', title:'Alice & Tom', maxPoints:3},
    {id:'test2', title:'Sports', maxPoints:3},
    {id:'test3', title:'Holidays', maxPoints:5},
    {id:'test4', title:'Environment', maxPoints:3},
    {id:'test5', title:'Daily Life', maxPoints:5},
  ];

  const allTests = [...baseTests];
  for(const level in testsJSON){
    allTests.push(...testsJSON[level].map(t=>({id:t.id, title:t.title, maxPoints:t.maxPoints ?? 5})));
  }

  let loaded=0;
  for(const test of allTests){
    const attemptsCol = collection(db,"results",uid,`${test.id}_attempts`);
    const snap = await getDocs(attemptsCol);
    const lastScore = snap.empty ? 0 : snap.docs[snap.docs.length-1].data().score ?? 0;
    const percent = Math.round(lastScore/test.maxPoints*100);

    totalScore += lastScore;
    totalMax += test.maxPoints;

    html+=`<tr><td>${test.title}</td><td>${lastScore} / ${test.maxPoints}</td>
      <td><div class="progress-container"><div class="progress-bar" style="width:${percent}%">${percent}%</div></div></td></tr>`;

    chartLabels.push(test.title);
    chartData.push(lastScore);

    loaded++;
    statsLoader.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏‚Ä¶ ${Math.round(loaded/allTests.length*100)}% ‚è≥`;
  }

  html+=`<tr><td><strong>–ò—Ç–æ–≥–æ</strong></td><td>${totalScore} / ${totalMax}</td><td></td></tr></table>`;
  statsDiv.innerHTML = html;

  if(chartData.length>0){
    chartCanvas.style.display="block";
    if(scoreChartInstance) scoreChartInstance.destroy();
    scoreChartInstance = new Chart(chartCanvas,{
      type:'line',
      data:{ labels:chartLabels, datasets:[{label:'–ë–∞–ª–ª—ã', data:chartData, borderColor:'blue', fill:false, tension:0.2}] },
      options:{ responsive:true }
    });
  } else chartCanvas.style.display="none";
}
</script>

</body>
</html>
