<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>English OGE Tests – Статистика</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; line-height: 1.6; }
h1 { text-align: center; }
.menu { margin-top: 30px; }
.menu a { display: block; padding: 10px; margin-bottom: 10px; border: 1px solid #333; text-decoration: none; color: black; width: 250px; }
#stats, #charts { margin-top: 30px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
input, button { padding: 5px; margin: 5px 0; }
</style>
</head>
<body>

<h1>English OGE Tests</h1>

<div id="auth">
  <h3>Авторизация</h3>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Пароль"><br>
  <button id="register-btn">Зарегистрироваться</button>
  <button id="login-btn">Войти</button>
  <button id="logout-btn" style="display:none;">Выйти</button>
  <div id="auth-msg"></div>
</div>

<div class="menu">
  <a href="test1.html" target="_blank">Test 1: Alice & Tom</a>
  <a href="test2.html" target="_blank">Test 2: Sports</a>
  <a href="test3.html" target="_blank">Test 3: Holidays</a>
  <a href="test4.html" target="_blank">Test 4: Environment</a>
  <a href="test5.html" target="_blank">Test 5: Daily Life</a>
</div>

<div id="stats">Войдите, чтобы увидеть статистику.</div>
<canvas id="scoreChart" style="max-width: 800px; margin-top: 30px;"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ====== Firebase конфиг ======
const firebaseConfig = {
  apiKey: "AIzaSyCi7KCyrHNE_D1Eq5WGb8Zrr-loh-xFyj0",
  authDomain: "engtestoge.firebaseapp.com",
  projectId: "engtestoge"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Элементы
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMsg = document.getElementById("auth-msg");
const statsDiv = document.getElementById("stats");
const chartCanvas = document.getElementById("scoreChart");

// Регистрация
registerBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    authMsg.innerText = "Регистрация успешна!";
  } catch (err) {
    authMsg.innerText = "Ошибка: " + err.message;
  }
});

// Вход
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    authMsg.innerText = "Вход выполнен!";
  } catch (err) {
    authMsg.innerText = "Ошибка: " + err.message;
  }
});

// Выход
logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
  } catch (err) {
    alert("Ошибка выхода: " + err.message);
  }
});

// Отслеживаем состояние авторизации
onAuthStateChanged(auth, async (user) => {
  if (user) {
    emailInput.style.display = "none";
    passwordInput.style.display = "none";
    registerBtn.style.display = "none";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline";
    authMsg.innerText = "Вы вошли как: " + user.email;
    await showFullStats(user.uid);
  } else {
    emailInput.style.display = "inline";
    passwordInput.style.display = "inline";
    registerBtn.style.display = "inline";
    loginBtn.style.display = "inline";
    logoutBtn.style.display = "none";
    statsDiv.innerText = "Войдите, чтобы увидеть статистику.";
    chartCanvas.style.display = "none";
  }
});

// Функция для вывода статистики и графика
async function showFullStats(uid) {
  const attemptsCol = collection(db, "results", uid, "attempts");
  const snapshot = await getDocs(attemptsCol);

  if (snapshot.empty) {
    statsDiv.innerText = "Нет попыток";
    chartCanvas.style.display = "none";
    return;
  }

  let tableHTML = "<h2>История результатов</h2>";
  const chartLabels = [];
  const chartData = [];
  let totalScore = 0;
  let totalMaxScore = 0;
  const maxPointsByTest = { test1: 3, test2: 3, test3: 5, test4: 3, test5: 5 };
  const testsData = {};

  snapshot.forEach(doc => {
    const data = doc.data();
    const testId = data.testId || "unknown";
    const score = data.score ?? 0;
    const dateStr = data.date?.toDate ? data.date.toDate().toLocaleString() : "неизвестно";

    if (!testsData[testId]) testsData[testId] = [];
    testsData[testId].push({ dateStr, score });

    totalScore += score;
    totalMaxScore += maxPointsByTest[testId] ?? 0;

    chartLabels.push(`${testId} (${dateStr.split(',')[0]})`);
    chartData.push(score);
  });

  for (let testId in maxPointsByTest) {
    tableHTML += `<h3>${testId}</h3>`;
    if (!testsData[testId] || testsData[testId].length === 0) {
      tableHTML += "<p>Нет попыток</p>";
      continue;
    }

    tableHTML += `<table><tr><th>Дата</th><th>Баллы</th></tr>`;
    testsData[testId].forEach(item => {
      tableHTML += `<tr><td>${item.dateStr}</td><td>${item.score} / ${maxPointsByTest[testId]}</td></tr>`;
    });
    tableHTML += "</table>";
  }

  tableHTML += `<p><strong>Общий результат: ${totalScore} / ${totalMaxScore}</strong></p>`;
  statsDiv.innerHTML = tableHTML;

  if (chartData.length > 0) {
    chartCanvas.style.display = "block";
    new Chart(chartCanvas, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Баллы',
          data: chartData,
          borderColor: 'blue',
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Прогресс пользователя' }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  } else {
    chartCanvas.style.display = "none";
  }
}
</script>

</body>
</html>
